<script>
    let STATE = { households: [], projects: [], donations: [] };
    let CHARTS = {}; // Store chart instances

    window.addEventListener('error', (event) => {
        const err = event?.error instanceof Error ? event.error : new Error(event?.message || 'Unknown error');
        try { showError(err); } catch { console.error(err); }
    });

    window.addEventListener('unhandledrejection', (event) => {
        const reason = event?.reason;
        const err = reason instanceof Error ? reason : new Error(typeof reason === 'string' ? reason : JSON.stringify(reason));
        try { showError(err); } catch { console.error(err); }
    });

    window.onload = function () {
        document.getElementById('date').valueAsDate = new Date();
        google.script.run
            .withSuccessHandler(initApp)
            .withFailureHandler(showError)
            .getInitialData();
    };

    function initApp(resp) {
        console.log('initApp started with response:', resp);
        try {
            if (!resp) throw new Error("No response received from backend");
            if (resp.status === 'error') throw new Error("Server Error: " + resp.message);
            if (!resp.data) throw new Error("Response is missing data payload");

            const data = resp.data;

            STATE.households = data.households || [];
            STATE.projects = data.projects || [];
            STATE.donations = data.donations || [];

            renderFilters();
            populateHouseholdFilters(); // Initialize Household Year Dropdown

            // Populate Projects Dropdown (Modal)
            const projectSelect = document.getElementById('project');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">No Project</option>';
                STATE.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.project_id;
                    option.textContent = p.name;
                    projectSelect.appendChild(option);
                });
            } else {
                console.warn('Project dropdown not found');
            }

            initAutocomplete();

            // Initial Render based on active view or default
            const activeView = document.querySelector('.view-section:not(.d-none)');

            console.log('Active View found:', activeView ? activeView.id : 'None');

            if (activeView && activeView.id !== 'view-dashboard') {
                if (activeView.id === 'view-households') {
                    console.log('Triggering renderHouseholdsDirectory from initApp');
                    renderHouseholdsDirectory();
                }
                if (activeView.id === 'view-projects') {
                    renderProjectsDirectory();
                }
                if (activeView.id === 'view-donations') {
                    renderDonationsTable();
                }
            } else {
                console.log('Defaulting to Dashboard render');
                try { renderDashboard(); } catch (e) { console.warn('Dashboard render failed', e); }
            }

            // Initialize auto-naming
            setupHouseholdAutoNaming();

            // Hide loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.opacity = '0';
                loadingOverlay.style.transition = 'opacity 0.3s ease';
                setTimeout(() => loadingOverlay.remove(), 300);
            }

        } catch (error) {
            console.error('CRITICAL INIT ERROR:', error);
            showError(error);
            // Hide loading overlay even on error
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.remove();
        }
    }

    function renderFilters() {
        // 1. Determine Years present in data
        const years = [...new Set(STATE.donations.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a); // Descending (Newest first)
        const currentYear = new Date().getFullYear();
        if (!years.includes(currentYear)) years.unshift(currentYear);

        // Ensure Min/Max for All Time
        const sortAsc = [...years].sort((a, b) => a - b);
        const minYear = sortAsc[0];
        const maxYear = sortAsc[sortAsc.length - 1];

        // 2. Initialize Hidden Range Selects (Source of Truth)
        const rangeSelects = [
            document.getElementById('filter-year-start'),
            document.getElementById('filter-year-end'),
            document.getElementById('dm-filter-year-start'),
            document.getElementById('dm-filter-year-end'),
            document.getElementById('export-filter-year-start'),
            document.getElementById('export-filter-year-end')
        ];

        rangeSelects.forEach(sel => {
            if (!sel) return;
            // Preserve value if possible
            const oldVal = sel.value;
            sel.innerHTML = '';
            sortAsc.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                sel.appendChild(opt);
            });
            // Default logic if no value
            if (sel.id.includes('start')) sel.value = oldVal || minYear;
            if (sel.id.includes('end')) sel.value = oldVal || maxYear;
        });

        // 3. Initialize "Mode" Selects
        const modeSelects = [
            { id: 'filter-year-mode', context: 'dashboard' },
            { id: 'dm-filter-year-mode', context: 'donations' },
            { id: 'export-filter-year-mode', context: 'export' }
        ];

        modeSelects.forEach(cfg => {
            const sel = document.getElementById(cfg.id);
            if (!sel) return;

            const existingVal = sel.value; // Preserve selection on re-render
            sel.innerHTML = '';

            // Options: Years, All Time, Custom
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y; // "2024"
                sel.appendChild(opt);
            });

            // Separator
            const sep = document.createElement('option');
            sep.disabled = true;
            sep.textContent = '──────────';
            sel.appendChild(sep);

            // All Time
            const optAll = document.createElement('option');
            optAll.value = 'ALL';
            optAll.textContent = 'All Time';
            sel.appendChild(optAll);

            // Custom
            const optCustom = document.createElement('option');
            optCustom.value = 'CUSTOM';
            optCustom.textContent = 'Custom Range...';
            sel.appendChild(optCustom);

            // Apply Default: Current Year (first in desc list)
            if (existingVal && (years.includes(parseInt(existingVal)) || existingVal === 'ALL' || existingVal === 'CUSTOM')) {
                sel.value = existingVal;
            } else {
                sel.value = currentYear.toString();
                // If data doesn't have current year, it might be empty, but we added it to list.
                // So defaulting to top of list is safe.
            }

            // Trigger Change to sync hidden fields
            handleYearModeChange(cfg.context, true); // true = suppressRender to avoid double render on init
        });

        // Populate Filter Projects (Dashboard)
        const filterProject = document.getElementById('filter-project');
        if (filterProject) {
            const currentProj = filterProject.value;
            filterProject.innerHTML = '<option value="All">All Projects</option>';
            STATE.projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.project_id;
                option.textContent = p.name;
                filterProject.appendChild(option);
            });
            filterProject.value = currentProj;
            if (filterProject.value !== currentProj) filterProject.value = 'All';
        }

        // Populate Donation Management Household Filter - MOVED to Autocomplete logic (No longer select)
        // Check if we need to do anything here for the input?
        // Since it's an input with autocomplete, we rely on the user typing.
        // We do not prepopulate options.

    }

    function handleYearModeChange(context, suppressRender = false) {
        let modeId, rangeDivId, startId, endId;

        if (context === 'dashboard') {
            modeId = 'filter-year-mode';
            rangeDivId = 'dashboard-custom-range';
            startId = 'filter-year-start';
            endId = 'filter-year-end';
        } else if (context === 'donations') {
            modeId = 'dm-filter-year-mode';
            rangeDivId = 'donations-custom-range';
            startId = 'dm-filter-year-start';
            endId = 'dm-filter-year-end';
        } else if (context === 'export') {
            modeId = 'export-filter-year-mode';
            rangeDivId = 'export-custom-range';
            startId = 'export-filter-year-start';
            endId = 'export-filter-year-end';
        }

        const modeSel = document.getElementById(modeId);
        const rangeDiv = document.getElementById(rangeDivId);
        const startSel = document.getElementById(startId);
        const endSel = document.getElementById(endId);

        if (!modeSel || !rangeDiv || !startSel || !endSel) return;

        const val = modeSel.value;

        if (val === 'CUSTOM') {
            rangeDiv.classList.remove('d-none');
            // Do not touch start/end values, let user edit them
        } else {
            rangeDiv.classList.add('d-none');

            if (val === 'ALL') {
                // Set to min/max available in the options
                if (startSel.options.length > 0) {
                    startSel.value = startSel.options[0].value; // Sorted Ascending in init
                    endSel.value = endSel.options[endSel.options.length - 1].value;
                }
            } else {
                // Single Year (e.g. "2024")
                // Set both start and end to this year
                startSel.value = val;
                endSel.value = val;
            }
        }

        if (!suppressRender) {
            if (context === 'dashboard') renderDashboard();
            if (context === 'donations') renderDonationsTable();
        }
    }

    // --- UTILS ---
    function formatDateUS(isoDateString) {
        if (!isoDateString) return '';
        const d = new Date(isoDateString);
        if (isNaN(d.getTime())) return isoDateString; // Validation fallback
        return d.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    }

    function formatDateTimeUS(isoDateString) {
        if (!isoDateString) return '';
        const d = new Date(isoDateString);
        if (isNaN(d.getTime())) return isoDateString; // Validation fallback
        return d.toLocaleDateString('en-US', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }) + ' ' + d.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }



    // --- NAVIGATION & HISTORY ---
    const HISTORY = {
        stack: [],
        push: function (viewId) {
            try {
                const state = this.captureState(viewId);
                this.stack.push(state);
                this.updateBackButton();
            } catch (e) {
                console.error('HISTORY.push error:', e);
            }
        },
        pop: function () {
            if (this.stack.length === 0) return null;
            const state = this.stack.pop();
            this.updateBackButton();
            return state;
        },
        updateBackButton: function () {
            const btnContainer = document.getElementById('nav-back-container');
            if (btnContainer) {
                if (this.stack.length > 0) {
                    btnContainer.classList.remove('d-none');
                } else {
                    btnContainer.classList.add('d-none');
                }
            }
        },
        captureState: function (viewId) {
            const state = {
                viewId: viewId,
                timestamp: Date.now(),
                data: {}
            };

            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : null;
            };

            const getChecked = (id) => {
                const el = document.getElementById(id);
                return el ? el.checked : false;
            };

            // Capture View-Specific Filters
            if (viewId === 'view-households') {
                state.data = {
                    search: getVal('hh-filter-search') || '',
                    address: getVal('hh-filter-address') || '',
                    year: getVal('hh-filter-year') || 'All',
                    email: getChecked('hh-filter-email'),
                    sort: getVal('hh-sort-by') || 'name_asc'
                };
            } else if (viewId === 'view-donations') {
                state.data = {
                    yearMode: getVal('dm-filter-year-mode'),
                    yearStart: getVal('dm-filter-year-start'),
                    yearEnd: getVal('dm-filter-year-end'),
                    householdSearch: getVal('dm-filter-household-search') || '',
                    householdId: getVal('dm-filter-household') || 'All',
                    method: getVal('dm-filter-method') || 'All'
                };
            } else if (viewId === 'view-dashboard') {
                state.data = {
                    yearMode: getVal('filter-year-mode'),
                    yearStart: getVal('filter-year-start'),
                    yearEnd: getVal('filter-year-end'),
                    project: getVal('filter-project') || 'All',
                    method: getVal('filter-method') || 'All',
                    amount: getVal('filter-amount') || '0'
                };
            } else if (viewId === 'view-export') {
                // Radio selection handle
                let recordType = 'donations';
                const radio = document.querySelector('input[name="exportRecordType"]:checked');
                if (radio) recordType = radio.value;

                state.data = {
                    yearMode: getVal('export-filter-year-mode'),
                    yearStart: getVal('export-filter-year-start'),
                    yearEnd: getVal('export-filter-year-end'),
                    householdSearch: getVal('export-filter-household-search') || '',
                    householdId: getVal('export-filter-household') || 'All',
                    method: getVal('export-filter-method') || 'All',
                    recordType: recordType
                };
            }

            return state;
        },
        restoreState: function (state) {
            if (!state) return;

            // 1. Switch View (Without pushing to stack again)
            window.switchView(state.viewId, null, true); // true = isHistoryNavigation

            // 2. Restore Filters
            const d = state.data;
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if (el && val !== null && val !== undefined) el.value = val;
            };
            const setChecked = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.checked = !!val;
            };

            if (state.viewId === 'view-households') {
                setVal('hh-filter-search', d.search);
                setVal('hh-filter-address', d.address);
                setVal('hh-filter-year', d.year);
                setChecked('hh-filter-email', d.email);
                setVal('hh-sort-by', d.sort);
                renderHouseholdsDirectory();
            } else if (state.viewId === 'view-donations') {
                if (document.getElementById('dm-filter-year-mode')) {
                    document.getElementById('dm-filter-year-mode').value = d.yearMode;
                    handleYearModeChange('donations', true); // Sync hidden
                }
                setVal('dm-filter-year-start', d.yearStart);
                setVal('dm-filter-year-end', d.yearEnd);
                setVal('dm-filter-household-search', d.householdSearch);
                setVal('dm-filter-household', d.householdId);
                setVal('dm-filter-method', d.method);
                renderDonationsTable();
            } else if (state.viewId === 'view-dashboard') {
                if (document.getElementById('filter-year-mode')) {
                    document.getElementById('filter-year-mode').value = d.yearMode;
                    handleYearModeChange('dashboard', true);
                }
                setVal('filter-year-start', d.yearStart);
                setVal('filter-year-end', d.yearEnd);
                setVal('filter-project', d.project);
                setVal('filter-method', d.method);
                if (document.getElementById('filter-amount')) {
                    document.getElementById('filter-amount').value = d.amount;
                    const display = document.getElementById('slider-val-display');
                    if (display) display.textContent = '$' + d.amount;
                }
                renderDashboard();
            } else if (state.viewId === 'view-export') {
                if (document.getElementById('export-filter-year-mode')) {
                    document.getElementById('export-filter-year-mode').value = d.yearMode;
                    handleYearModeChange('export', true);
                }
                setVal('export-filter-year-start', d.yearStart);
                setVal('export-filter-year-end', d.yearEnd);
                setVal('export-filter-household-search', d.householdSearch);
                setVal('export-filter-household', d.householdId);
                setVal('export-filter-method', d.method);
                if (d.recordType) {
                    const radio = document.querySelector(`input[name="exportRecordType"][value="${d.recordType}"]`);
                    if (radio) radio.checked = true;
                }
                updateExportPreview();
            }
        }
    };

    window.goBack = function () {
        const prevState = HISTORY.pop();
        if (prevState) {
            HISTORY.restoreState(prevState);
        }
    };

    window.switchView = function (viewId, linkElement, isHistoryNavigation = false) {
        // 0. Push CURRENT view to History before switching (if not going back)
        if (!isHistoryNavigation) {
            try {
                const currentView = document.querySelector('.view-section:not(.d-none)');
                if (currentView) {
                    // Eliminate self-navigation (pushing same view)
                    if (currentView.id !== viewId) {
                        HISTORY.push(currentView.id);
                    }
                }
            } catch (err) {
                console.warn("History push failed, continuing navigation:", err);
            }
        }

        // 1. Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));

        // 2. Show target
        const target = document.getElementById(viewId);
        if (target) {
            target.classList.remove('d-none');
        } else {
            console.error(`View with ID '${viewId}' not found.`);
            return;
        }

        // 3. Update Sidebar Active State
        // If linkElement is null (e.g. back button or drilldown), try to match by ID mapping
        if (!linkElement) {
            const map = {
                'view-dashboard': 'nav-dashboard',
                'view-donations': 'nav-donations',
                'view-households': 'nav-households',
                'view-projects': 'nav-projects',
                'view-export': 'nav-export'
            };
            const navId = map[viewId];
            if (navId) linkElement = document.getElementById(navId);
        }

        if (linkElement) {
            document.querySelectorAll('#sidebar-wrapper .list-group-item').forEach(el => {
                el.classList.remove('active', 'text-white');
                el.classList.add('text-white-50');
            });
            linkElement.classList.remove('text-white-50');
            linkElement.classList.add('active', 'text-white');
        }

        // 4. Trigger specific renders if needed
        if (!isHistoryNavigation) {
            if (viewId === 'view-households') renderHouseholdsDirectory();
            if (viewId === 'view-projects') renderProjectsDirectory();
            if (viewId === 'view-donations') renderDonationsTable();
            if (viewId === 'view-dashboard') renderDashboard();
            if (viewId === 'view-export') updateExportPreview();
        }
    }

    // Drill-down from Dashboard
    window.goToDonationsFiltered = function (overrides = {}) {
        // 1. Get Dashboard state
        const dashboardYearMode = document.getElementById('filter-year-mode').value;
        const startYear = document.getElementById('filter-year-start').value;
        const endYear = document.getElementById('filter-year-end').value;
        const project = document.getElementById('filter-project').value;
        const method = document.getElementById('filter-method').value;

        // 2. Set Donation Filters (sync with dashboard, apply overrides)
        const dYearMode = document.getElementById('dm-filter-year-mode');
        const dStart = document.getElementById('dm-filter-year-start');
        const dEnd = document.getElementById('dm-filter-year-end');
        const dHouse = document.getElementById('dm-filter-household');
        const dMethod = document.getElementById('dm-filter-method');

        // Sync year mode dropdown from Dashboard to Donations
        if (dYearMode) dYearMode.value = dashboardYearMode;
        if (dStart) dStart.value = startYear;
        if (dEnd) dEnd.value = endYear;
        // Update visibility of custom range div based on year mode
        handleYearModeChange('donations', true);
        // Project filter doesn't exist in Donations view currently, but we filter loosely by it? 
        // User didn't ask to add Project filter to donation view, but likely expects functionality.
        // The implementation plan implies applying filters. 
        // Donations view handles Project via columns, but not explicit filter dropdown.
        // Wait, if I click "By Project" chart, I expect to see only that project.
        // Use a hidden or new mechanism? OR just filter in `renderDonationsTable` based on a global or arg?
        // Actually, `renderDonationsTable` reads from DOM elements. 
        // To support project filtering from drill-down without a dropdown, we might need a temporary state or add the dropdown.
        // Let's add a temporary global filter state or valid Project Filter to donations view? 
        // The user didn't explicitly ask for a Project Filter dropdown in Donations view, but did ask for drill down.
        // I will assume for now I should just set the other filters.
        // Update: Implementation plan said "Syncs filters ... Applies overrides".

        // Handle explicit "Method" override
        if (overrides.method) {
            dMethod.value = overrides.method;
        } else if (method !== 'All') {
            dMethod.value = method;
        } else {
            dMethod.value = 'All';
        }

        // Handle Household (default All unless specific context which is not dashboard usually)
        if (dHouse) dHouse.value = 'All';

        // 3. Switch View
        // Find the donations link in sidebar
        const donationsLink = document.getElementById('nav-donations');
        switchView('view-donations', donationsLink);

        // 4. Trigger Render with potential special parameters?
        // If we need to filter by Project (which has no dropdown in Donation View), we might fail to show "just that project".
        // Let's rely on what we have. If Project is clicked, we might need to add a Project filter to the Donation View to make it persistent.
        // The user *did* ask for "clicking By Project ... navigate to donations screen filtered by... project".
        // I should probably add a Project filter to Donation View to make this robust. 
        // For now, I'll implement basic sync.

        // Handling Project Drilldown properly requires a target filter.
        // I will inject a Project filter into Donation View in the next step if strictly needed, 
        // but for now let's assume I can add it or just ignore if not present (but user asked for it).
        // Wait, `filteredDonations` in `renderDonationsTable` reads DOM. 
        // I'll add `window.currentProjectFilterOverride` to handle this transiently if I don't add a dropdown?
        // Better: Add the dropdown. It makes sense.

        // For this step, I'll just do the navigation and basic sync.
        // I will add the Project Filter to `renderDonationsTable` logic and Index.html in a moment or now?
        // I'll stick to replacing the logic here first.

        // Special case: Project override
        window.donationProjectFilter = overrides.project || (project !== 'All' ? project : null);

        renderDonationsTable();
    }

    // --- HOUSEHOLD NAME FORMATTING ---
    function formatHouseholdName(members) {
        if (!members || members.length === 0) return "Unknown";

        if (members.length === 1) {
            return `${members[0].first_name} ${members[0].last_name}`;
        }

        // Check if all members share the same last name
        const lastNames = members.map(m => m.last_name);
        const allSameLastName = lastNames.every(ln => ln === lastNames[0]);

        if (allSameLastName) {
            // "John and Jane Smith"
            const firstNames = members.map(m => m.first_name).join(' and ');
            return `${firstNames} ${lastNames[0]}`;
        } else {
            // "John Smith & Jane Doe"
            const fullNames = members.map(m => `${m.first_name} ${m.last_name}`);
            return fullNames.join(' & ');
        }
    }

    // --- HOUSEHOLD FILTERING HELPERS ---
    function populateHouseholdFilters() {
        const yearSelect = document.getElementById('hh-filter-year');
        if (!yearSelect) return;

        // Save current selection if re-initializing
        const currentVal = yearSelect.value;

        yearSelect.innerHTML = '<option value="All">All Time</option>';

        // Get Years from Donations
        const years = [...new Set(STATE.donations.map(d => new Date(d.date).getFullYear()))].sort((a, b) => b - a);

        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            yearSelect.appendChild(opt);
        });

        // Add 'Never Donated' Option
        const optNever = document.createElement('option');
        optNever.value = 'Never';
        optNever.textContent = 'Never Donated';
        yearSelect.appendChild(optNever);

        // Restore Selection if valid
        if (currentVal && (years.includes(parseInt(currentVal)) || currentVal === 'All' || currentVal === 'Never')) {
            yearSelect.value = currentVal;
        }
    }

    function resetHouseholdFilters() {
        document.getElementById('hh-filter-search').value = '';
        document.getElementById('hh-filter-address').value = '';
        document.getElementById('hh-filter-year').value = 'All';
        document.getElementById('hh-filter-email').checked = false;
        renderHouseholdsDirectory();
    }

    // --- HOUSEHOLD MANAGEMENT ---
    function renderHouseholdsDirectory() {
        console.log('renderHouseholdsDirectory() called');
        try {
            const grid = document.getElementById('households-grid');
            const summaryDiv = document.getElementById('household-summary-stats');

            if (!grid) return;
            grid.innerHTML = '';
            if (summaryDiv) summaryDiv.textContent = '';

            if (!STATE.households || !Array.isArray(STATE.households)) {
                grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">No household data available</div></div>';
                return;
            }

            if (STATE.households.length === 0) {
                grid.innerHTML = '<div class="col-12"><div class="alert alert-info">No households found. Click "Add New Household" to get started.</div></div>';
                return;
            }

            // --- FILTERING LOGIC ---
            const searchTerm = (document.getElementById('hh-filter-search')?.value || '').toLowerCase().trim();
            const addressTerm = (document.getElementById('hh-filter-address')?.value || '').toLowerCase().trim();
            const yearFilter = document.getElementById('hh-filter-year')?.value || 'All';
            const emailFilter = document.getElementById('hh-filter-email')?.checked || false;
            const sortBy = document.getElementById('hh-sort-by')?.value || 'name_asc';

            // Pre-calculate donors for selected year
            let authorizedIdsForYear = null;
            if (yearFilter !== 'All') {
                if (yearFilter === 'Never') {
                    const allDonorIds = new Set(STATE.donations.map(d => d.household_id));
                    authorizedIdsForYear = { type: 'never', set: allDonorIds };
                } else {
                    const targetYear = parseInt(yearFilter);
                    const specificDonorIds = new Set(
                        STATE.donations
                            .filter(d => new Date(d.date).getFullYear() === targetYear)
                            .map(d => d.household_id)
                    );
                    authorizedIdsForYear = { type: 'year', set: specificDonorIds };
                }
            }

            // 1. Filter
            const filtered = STATE.households.filter(h => {
                // Name
                let nameMatch = true;
                if (searchTerm) {
                    const hhName = (h.household_name || '').toLowerCase();
                    const memberNames = (h.members || []).map(m => (m.first_name + ' ' + m.last_name).toLowerCase()).join(' ');
                    if (!hhName.includes(searchTerm) && !memberNames.includes(searchTerm)) nameMatch = false;
                }

                // Address
                let addrMatch = true;
                if (addressTerm) {
                    const displayAddr = h.address ?
                        `${h.address.street} ${h.address.city} ${h.address.state} ${h.address.zip}`.toLowerCase() : '';
                    if (!displayAddr.includes(addressTerm)) addrMatch = false;
                }

                // Email
                let emailMatch = true;
                if (emailFilter) {
                    const hasEmail = (h.members || []).some(m => m.email && m.email.trim() !== '');
                    if (!hasEmail) emailMatch = false;
                }

                // Year
                let yearMatch = true;
                if (authorizedIdsForYear && nameMatch && addrMatch && emailMatch) {
                    if (authorizedIdsForYear.type === 'never') {
                        if (authorizedIdsForYear.set.has(h.household_id)) yearMatch = false;
                    } else {
                        if (!authorizedIdsForYear.set.has(h.household_id)) yearMatch = false;
                    }
                }

                return nameMatch && addrMatch && emailMatch && yearMatch;
            });

            // 2. Enrich with Stats (for Sorting & Summary)
            // We need to calculate totals relative to the *Filtered Year*? 
            // The user request implies "Donation Total (auto updates)". 
            // Usually this means "Total given by these people in the selected context".
            // If Year=2024, should the total be *Lifetime* or *2024*?
            // "The cards displayed should auto update... Donation Total (auto updates)". 
            // Standard directory behavior often shows Lifetime, but if I filter by 2024, showing 2024 giving is powerful.
            // HOWEVER, the card shows "Lifetime" value currently. 
            // I will stick to LIFETIME value for sorting/card display to avoid confusion unless I change the card UI too.
            // But the *Summary* at the top should probably be the Sum of Lifetime Giving of these people? 
            // Or if I filter by 2024, show their 2024 giving?
            // Let's implement LIFETIME stats for now as it's the robust default.

            const enriched = filtered.map(h => {
                const hDonations = (STATE.donations || []).filter(d => d.household_id === h.household_id);
                const totalCents = hDonations.reduce((sum, d) => sum + (d.amount_cents || 0), 0);

                // Last Gift
                let lastGiftTime = 0;
                let lastGiftDateStr = 'Never';
                if (hDonations.length > 0) {
                    const times = hDonations.map(d => new Date(d.date).getTime());
                    lastGiftTime = Math.max(...times);
                    lastGiftDateStr = new Date(lastGiftTime).toLocaleDateString();
                }

                return {
                    ...h,
                    stats: {
                        totalCents: totalCents,
                        count: hDonations.length,
                        lastGiftTime: lastGiftTime,
                        lastGiftDateStr: lastGiftDateStr
                    }
                };
            });

            // 3. Update Summary
            if (summaryDiv) {
                const count = enriched.length;
                const totalValue = enriched.reduce((sum, h) => sum + h.stats.totalCents, 0) / 100;
                const fmtTotal = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(totalValue);
                summaryDiv.innerHTML = `<span class="fw-bold text-dark">${count}</span> ${count === 1 ? 'Household' : 'Households'} &bull; <span class="fw-bold text-success">${fmtTotal}</span> <span class="text-muted">Lifetime Value</span>`;
            }

            if (enriched.length === 0) {
                grid.innerHTML = '<div class="col-12"><div class="alert alert-secondary text-center">No households match your filters. <a href="#" onclick="resetHouseholdFilters()" class="alert-link">Reset Filters</a></div></div>';
                return;
            }

            // 4. Sort
            enriched.sort((a, b) => {
                switch (sortBy) {
                    case 'name_desc':
                        return (b.household_name || '').localeCompare(a.household_name || '');
                    case 'total_desc':
                        return b.stats.totalCents - a.stats.totalCents;
                    case 'last_gift_desc':
                        return b.stats.lastGiftTime - a.stats.lastGiftTime;
                    case 'name_asc':
                    default:
                        return (a.household_name || '').localeCompare(b.household_name || '');
                }
            });

            // 5. Render
            enriched.forEach((h, index) => {
                // Ensure members array exists
                if (!h.members) h.members = [];

                const formattedTotal = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(h.stats.totalCents / 100);

                const address = h.address ?
                    `${escapeHtml(h.address.street || '')}${h.address.street2 ? ', ' + escapeHtml(h.address.street2) : ''}, ${escapeHtml(h.address.city || '')}, ${escapeHtml(h.address.state || '')} ${escapeHtml(h.address.zip || '')}`.replace(/^[,\s]+|[,\s]+$/g, '')
                    : 'No Address';

                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';

                // Assign Color
                const colorClass = `card-color-${index % 9}`;

                // Generate Member List HTML
                const membersHtml = h.members.length > 0 ? h.members.map(m => {
                    const parts = [];
                    if (m.email) parts.push(`<a href="mailto:${escapeHtml(m.email)}" class="text-decoration-none text-muted" onclick="event.stopPropagation()"><i class="bi bi-envelope"></i> ${escapeHtml(m.email)}</a>`);
                    if (m.phone) parts.push(`<span class="text-muted"><i class="bi bi-telephone"></i> ${escapeHtml(m.phone)}</span>`);
                    const contactInfo = parts.join(' &bull; ');

                    return `
                    <div class="mb-2 pb-2 border-bottom last-child-no-border">
                        <strong>${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}</strong>
                        ${contactInfo ? `<div class="small">${contactInfo}</div>` : ''}
                    </div>
                `;
                }).join('') : '<div class="text-muted fst-italic">No members listed</div>';

                col.innerHTML = `
                <div class="card h-100 shadow-sm ${colorClass}" style="cursor: pointer;" onclick="editHousehold('${escapeHtml(h.household_id)}')">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-truncate" title="${escapeHtml(h.household_name)}">${escapeHtml(h.household_name)}</h5>
                        <!-- Dropdown Menu -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation()">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" type="button" onclick="event.stopPropagation(); editHousehold('${escapeHtml(h.household_id)}')"><i class="bi bi-pencil me-2"></i>Edit</button></li>
                                <li><button class="dropdown-item" type="button" onclick="event.stopPropagation(); viewHouseholdDonations('${escapeHtml(h.household_id)}')"><i class="bi bi-wallet2 me-2"></i>History</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item text-danger" type="button" onclick="event.stopPropagation(); deleteHousehold('${escapeHtml(h.household_id)}')"><i class="bi bi-trash me-2"></i>Delete</button></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                         <!-- Statistics Row -->
                         <div class="row mb-3 text-center border-bottom pb-2">
                            <div class="col-4 border-end">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Lifetime</span>
                                <span class="fw-bold text-success">${formattedTotal}</span>
                            </div>
                            <div class="col-4 border-end">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Gifts</span>
                                <span class="fw-bold">${h.stats.count}</span>
                            </div>
                             <div class="col-4">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Last</span>
                                <span class="fw-bold small">${h.stats.lastGiftDateStr}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            ${membersHtml}
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-geo-alt me-1"></i> ${address}
                        </div>
                    </div>
                </div>
            `;
                grid.appendChild(col);
            });
            console.log('renderHouseholdsDirectory() completed');
        } catch (e) {
            console.error('Error in renderHouseholdsDirectory:', e);
            const grid = document.getElementById('households-grid');
            if (grid) grid.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error rendering households: ${e.message}</div></div>`;
        }
    }

    function viewHouseholdDonations(id) {
        // Check if we're already in the Donations view - if so, manually push current state
        // This enables proper Back navigation when drilling down within the same view
        const currentView = document.querySelector('.view-section:not(.d-none)');
        if (currentView && currentView.id === 'view-donations') {
            // We're already in Donations view, so switchView won't push state (same view check)
            // Manually push current state before changing filters
            HISTORY.push('view-donations');
        }

        // Find the donations nav link to update active state
        const donationsLink = document.getElementById('nav-donations');
        switchView('view-donations', donationsLink);

        // 1. Set Household Filter
        const household = STATE.households.find(h => h.household_id === id);
        const hhInput = document.getElementById('dm-filter-household-search');
        const hhHidden = document.getElementById('dm-filter-household');

        if (household && hhInput && hhHidden) {
            hhInput.value = household.household_name;
            hhHidden.value = id;
            hhInput.classList.add('is-valid'); // Visual feedback
        }

        // 2. Set Year Filter to All Time
        const yearMode = document.getElementById('dm-filter-year-mode');
        if (yearMode) {
            yearMode.value = 'ALL';
            handleYearModeChange('donations', true); // Update start/end hidden fields without double rendering
        }

        // 3. Reset Method Filter (optional but good practice)
        const methodFilter = document.getElementById('dm-filter-method');
        if (methodFilter) methodFilter.value = 'All';

        // 4. Clear project filter override (if any)
        window.donationProjectFilter = null;

        // 5. Render
        renderDonationsTable();
    }

    // Dynamic member input management
    let memberCount = 1;

    // --- PHONE FORMATTING ---
    function formatPhoneNumber(value) {
        if (!value) return value;
        const current = value.replace(/[^\d]/g, '');
        const mobileReg = /(^[0-9]{3})([0-9]{3})([0-9]{4}$)/;
        if (current.length >= 10) {
            return current.replace(mobileReg, '($1) $2-$3').slice(0, 14); // Limit length
        }
        return value;
    }

    function setupPhoneFormatter(input) {
        input.addEventListener('input', function (e) {
            const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
    }

    function setupEmailValidation(input) {
        input.addEventListener('blur', function (e) {
            const email = e.target.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email && !emailRegex.test(email)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });

        // Remove invalid state as soon as user types again
        input.addEventListener('input', function (e) {
            e.target.classList.remove('is-invalid');
        });
    }

    // --- AUTO-GENERATION LOGIC ---
    let isHouseholdNameManuallyEdited = false;

    function setupHouseholdAutoNaming() {
        const nameInput = document.getElementById('h-name');

        // Track manual edits
        nameInput.addEventListener('input', () => {
            if (nameInput.value.trim() !== '') {
                isHouseholdNameManuallyEdited = true;
            }
        });


        // Attach to initial Member 1
        attachNameListeners(1);
        setupPhoneFormatter(document.getElementById('m1-phone'));
        setupEmailValidation(document.getElementById('m1-email'));

    }

    function openAddHouseholdModal() {
        resetAddHouseholdModal();
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function attachNameListeners(id) {
        const first = document.getElementById(`m${id}-first`);
        const last = document.getElementById(`m${id}-last`);

        if (first) first.addEventListener('input', updateHouseholdNameAuto);
        if (last) last.addEventListener('input', updateHouseholdNameAuto);
    }

    function updateHouseholdNameAuto() {
        if (isHouseholdNameManuallyEdited) return;

        const members = [];
        // Scan all potential members up to memberCount
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            const lastInput = document.getElementById(`m${i}-last`);

            // Only include if input elements exist and have at least one name part
            if (firstInput && lastInput) {
                const first = firstInput.value.trim();
                const last = lastInput.value.trim();

                if (first || last) {
                    members.push({ first_name: first, last_name: last });
                }
            }
        }

        const nameInput = document.getElementById('h-name');
        if (members.length > 0) {
            nameInput.value = formatHouseholdName(members);
        } else {
            nameInput.value = '';
        }
    }

    function addMemberInput() {
        memberCount++;
        const container = document.getElementById('members-container');
        const memberDiv = document.createElement('div');
        memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
        memberDiv.id = `member-${memberCount}`;

        memberDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Member ${memberCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">
                    Remove
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-first" placeholder="First Name" required>
                    <input type="hidden" id="m${memberCount}-id">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-last" placeholder="Last Name" required>
                </div>
                <div class="col-md-6">
                    <input type="email" class="form-control" id="m${memberCount}-email" placeholder="Email (optional)">
                </div>
                <div class="col-md-6">
                    <input type="tel" class="form-control" id="m${memberCount}-phone" placeholder="Phone (optional)">
                </div>
            </div>
        `;

        container.appendChild(memberDiv);

        // Attach listeners to new inputs
        attachNameListeners(memberCount);
        setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
        setupEmailValidation(document.getElementById(`m${memberCount}-email`));
    }

    function removeMemberInput(id) {
        const element = document.getElementById(`member-${id}`);
        if (element) {
            element.remove();
            // Re-calculate name after removal
            updateHouseholdNameAuto();
        }
    }

    function resetAddHouseholdModal() {
        // Reset Form
        document.getElementById('add-household-form').reset();
        document.getElementById('household-id').value = ''; // Clear ID
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Add New Household';
        isHouseholdNameManuallyEdited = false; // Reset auto-naming flag

        // Reset members container to single member
        document.getElementById('members-container').innerHTML = `
            <div class="member-input-group p-3 mb-3 border rounded bg-light" id="member-1">
                <h6 class="mb-2">Member 1</h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-first" placeholder="First Name" required>
                         <input type="hidden" id="m1-id">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-last" placeholder="Last Name" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m1-email" placeholder="Email (optional)">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m1-phone" placeholder="Phone (optional)">
                    </div>
                </div>
            </div>
        `;
        memberCount = 1;
        attachNameListeners(1); // Re-attach listeners to new inputs
        setupPhoneFormatter(document.getElementById('m1-phone')); // Re-attach formatting
        setupEmailValidation(document.getElementById('m1-email')); // Re-attach validation
    }

    function editHousehold(id) {
        const household = STATE.households.find(h => h.household_id === id);
        if (!household) return;

        // Reset modal to clean state
        resetAddHouseholdModal();

        // 1. Set Household ID and basic info
        document.getElementById('household-id').value = household.household_id;
        document.getElementById('h-name').value = household.household_name;
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Edit Household';

        // Check if existing name matches the auto-generated pattern
        const autoName = formatHouseholdName(household.members);
        if (household.household_name === autoName) {
            isHouseholdNameManuallyEdited = false;
        } else {
            isHouseholdNameManuallyEdited = true;
        }

        // 2. Set Address
        if (household.address) {
            document.getElementById('h-street').value = household.address.street || '';
            document.getElementById('h-street2').value = household.address.street2 || '';
            document.getElementById('h-city').value = household.address.city || '';
            document.getElementById('h-state').value = household.address.state || '';
            document.getElementById('h-zip').value = household.address.zip || '';
        }

        // 3. Set Members
        const container = document.getElementById('members-container');
        container.innerHTML = '';
        memberCount = 0;

        household.members.forEach((m, index) => {
            memberCount++;
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
            memberDiv.id = `member-${memberCount}`;

            // For first member, don't show remove button? Or allowed if multiple?
            // Let's allow removing any member in edit mode, but validation requires at least 1.
            const removeBtn = `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">Remove</button>`;

            memberDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Member ${memberCount}</h6>
                    ${removeBtn}
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-first" value="${m.first_name}" required>
                         <input type="hidden" id="m${memberCount}-id" value="${m.member_id}">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-last" value="${m.last_name}" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m${memberCount}-email" value="${m.email || ''}">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m${memberCount}-phone" value="${m.phone || ''}">
                    </div>
                </div>
            `;
            container.appendChild(memberDiv);

            // Attach listeners
            attachNameListeners(memberCount);
            setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
            setupEmailValidation(document.getElementById(`m${memberCount}-email`));
        });

        // Open Modal
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function deleteHousehold(id) {
        if (!confirm('Are you sure you want to delete this household? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.households = STATE.households.filter(h => h.household_id !== id);
                renderHouseholdsDirectory();
                initAutocomplete(); // Refresh search index
                renderFilters(); // Added to refresh household filters
                showAlert('success', 'Household deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error deleting household: ' + err.message);
            })
            .deleteHousehold(id);
    }

    // --- PROJECT MANAGEMENT ---

    function renderProjectsDirectory() {
        console.log('renderProjectsDirectory() called');
        try {
            const grid = document.getElementById('projects-grid');
            if (!grid) {
                console.error('Projects grid element not found');
                return;
            }
            grid.innerHTML = '';

            if (!STATE.projects || !Array.isArray(STATE.projects)) {
                console.warn("STATE.projects is not an array:", STATE.projects);
                grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">No project data available</div></div>';
                return;
            }

            console.log(`Rendering ${STATE.projects.length} projects...`);

            if (STATE.projects.length === 0) {
                grid.innerHTML = '<div class="col-12"><div class="alert alert-info">No projects found. Click "Add Project" to get started.</div></div>';
                return;
            }

            // Sort by name
            const sorted = [...STATE.projects].sort((a, b) =>
                (a.name || '').localeCompare(b.name || '')
            );

            sorted.forEach(p => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';

                col.innerHTML = `
                    <div class="card h-100 shadow-sm border-0 border-start border-4 border-primary">
                        <div class="card-body">
                             <div class="d-flex justify-content-between align-items-start mb-2">
                                 <h5 class="card-title fw-bold text-primary mb-0">${escapeHtml(p.name)}</h5>
                             <div class="dropdown">
                                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><button class="dropdown-item" onclick="editProject('${escapeHtml(p.project_id)}')"><i class="bi bi-pencil me-2"></i>Edit</button></li>
                                    <li><button class="dropdown-item text-danger" onclick="deleteProject('${escapeHtml(p.project_id)}')"><i class="bi bi-trash me-2"></i>Delete</button></li>
                                </ul>
                            </div>
                        </div>

                        ${p.description ? `<p class="card-text small text-muted">${escapeHtml(p.description)}</p>` : '<p class="card-text small text-muted fst-italic">No description</p>'}
                    </div>
                </div>
             `;
                grid.appendChild(col);
            });
            console.log('renderProjectsDirectory() completed');
        } catch (e) {
            console.error('Error in renderProjectsDirectory:', e);
            const grid = document.getElementById('projects-grid');
            if (grid) grid.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error rendering projects: ${e.message}</div></div>`;
        }
    }

    function openAddProjectModal() {
        document.getElementById('add-project-form').reset();
        document.getElementById('project-id').value = '';
        document.querySelector('#addProjectModal .modal-title').textContent = 'Add New Project';
        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    function editProject(id) {
        const project = STATE.projects.find(p => p.project_id === id);
        if (!project) return;

        document.getElementById('project-id').value = project.project_id;
        document.getElementById('p-name').value = project.name;
        document.getElementById('p-desc').value = project.description || '';
        document.querySelector('#addProjectModal .modal-title').textContent = 'Edit Project';

        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    function submitProject() {
        const btn = document.getElementById('btn-save-project');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const project_id = document.getElementById('project-id').value;
        const name = document.getElementById('p-name').value;
        const description = document.getElementById('p-desc').value;

        if (!name) {
            alert("Project Name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { project_id, name, description };

        const handler = (res) => {
            // Handle Success
            if (project_id) {
                // Update Existing
                const idx = STATE.projects.findIndex(p => p.project_id === project_id);
                if (idx !== -1) STATE.projects[idx] = { project_id, name, description };
            } else {
                // Add New
                STATE.projects.push({ project_id: res.project_id, name: res.name, description });
            }

            // Refresh UI and Dropdown
            renderProjectsDirectory();
            refreshProjectDropdown();
            renderFilters(); // Added to refresh dashboard project filter // We need to create this helper or inline it

            // Close Modal
            const modalEl = document.getElementById('addProjectModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            document.getElementById('add-project-form').reset();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', project_id ? 'Project updated successfully!' : 'Project added successfully!');
        };

        if (project_id) {
            google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }).updateProject(payload);
        } else {
            google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }).saveProject(payload);
        }
    }

    function deleteProject(id) {
        if (!confirm('Are you sure you want to delete this project?')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.projects = STATE.projects.filter(p => p.project_id !== id);
                renderProjectsDirectory();
                refreshProjectDropdown();
                renderFilters(); // Added to refresh dashboard project filter
                showAlert('success', 'Project deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error: ' + err.message);
            })
            .deleteProject(id);
    }
    function refreshProjectDropdown() {
        const projectSelect = document.getElementById('project');
        projectSelect.innerHTML = '<option value="">No Project</option>';
        STATE.projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.project_id;
            option.textContent = p.name;
            projectSelect.appendChild(option);
        });
    }

    // --- ANALYTICS DASHBOARD ---

    function resetDashboardFilters() {
        document.getElementById('filter-year').value = 'All';
        document.getElementById('filter-project').value = 'All';
        document.getElementById('filter-method').value = 'All';
        document.getElementById('filter-amount').value = 0;
        document.getElementById('slider-val-display').textContent = '$0';
        renderDashboard();
    }

    function renderDashboard() {
        // 1. Get Filter Values
        const startYear = parseInt(document.getElementById('filter-year-start').value);
        const endYear = parseInt(document.getElementById('filter-year-end').value);
        const fProject = document.getElementById('filter-project').value;
        const fMethod = document.getElementById('filter-method').value;
        const fAmount = parseInt(document.getElementById('filter-amount').value);

        // 2. Filter Data
        const filtered = STATE.donations.filter(d => {
            const dYear = new Date(d.date).getFullYear();
            if (dYear < startYear || dYear > endYear) return false;

            if (fProject !== 'All' && d.project_id !== fProject) return false;
            if (fMethod !== 'All' && d.method !== fMethod) return false;
            if (d.amount_cents / 100 < fAmount) return false;
            return true;
        });

        // 3. Compute KPIs
        const totalCents = filtered.reduce((sum, d) => sum + d.amount_cents, 0);
        const totalRaised = totalCents / 100;
        const count = filtered.length;
        const avg = count ? (totalRaised / count) : 0;
        const uniqueDonors = new Set(filtered.map(d => d.household_id)).size;

        // 4. Update KPI Counters with Animation
        animateValue("kpi-total", totalRaised, "$");
        animateValue("kpi-count", count, "");
        animateValue("kpi-avg", avg, "$");
        animateValue("kpi-donors", uniqueDonors, "");

        // 5. Render Charts
        renderCharts(filtered);
    }

    function animateValue(id, value, prefix = "") {
        const obj = document.getElementById(id);
        const start = 0;
        const end = value;
        const duration = 800;
        let startTimestamp = null;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);

            // Format number
            const current = progress * (end - start) + start;
            let formatted;
            if (prefix === "$") {
                formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(current);
            } else {
                formatted = Math.floor(current);
            }

            obj.innerHTML = formatted;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function renderCharts(data) {
        // Prepare Data
        if (data.length === 0) return; // Handle empty

        // 1. Timeline (Monthly? Yearly?)
        const timelineData = {};
        data.forEach(d => {
            const y = new Date(d.date).getFullYear();
            timelineData[y] = (timelineData[y] || 0) + d.amount_cents / 100;
        });

        // 2. By Project
        const projectData = {};
        data.forEach(d => {
            const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'Unknown';
            projectData[pName] = (projectData[pName] || 0) + d.amount_cents / 100;
            // Store ID for lookup on click
            if (!projectData[pName + '_id']) projectData[pName + '_id'] = d.project_id;
        });

        // 3. Methods
        const methodData = {};
        data.forEach(d => {
            methodData[d.method] = (methodData[d.method] || 0) + d.amount_cents / 100;
        });

        // --- RENDER ---

        // Timeline
        renderChart('chart-timeline', 'bar', Object.keys(timelineData), Object.values(timelineData), 'Total Raised ($)');

        // Project
        // Custom render to attach IDs relative to labels?
        // ChartJS onClick gives index. We can map back to keys.
        const projLabels = Object.keys(projectData).filter(k => !k.endsWith('_id'));
        const projValues = projLabels.map(k => projectData[k]);

        renderChart('chart-project', 'doughnut', projLabels, projValues, 'By Project', {
            onClick: (evt, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = projLabels[index];
                    const pid = projectData[label + '_id'];
                    goToDonationsFiltered({ project: pid });
                }
            }
        });

        // Method
        const methodLabels = Object.keys(methodData);
        const methodValues = Object.values(methodData);
        renderChart('chart-method', 'pie', methodLabels, methodValues, 'Payment Methods', {
            onClick: (evt, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = methodLabels[index];
                    goToDonationsFiltered({ method: label });
                }
            }
        });
    }

    function renderChart(canvasId, type, labels, data, label, options = {}) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        if (CHARTS[canvasId]) {
            CHARTS[canvasId].destroy();
        }

        CHARTS[canvasId] = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#6f42c1'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                preserveAspectRatio: false,
                ...options
            }
        });
    }

    function submitHousehold() {
        const btn = document.getElementById('btn-save-household');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        // Collect household info
        const household_id = document.getElementById('household-id').value;
        const household_name = document.getElementById('h-name').value;
        const address = {
            street: document.getElementById('h-street').value,
            street2: document.getElementById('h-street2').value,
            city: document.getElementById('h-city').value,
            state: document.getElementById('h-state').value,
            zip: document.getElementById('h-zip').value
        };

        // Collect all members
        const members = [];
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            if (!firstInput) continue; // Skipped if removed

            const first_name = firstInput.value;
            const last_name = document.getElementById(`m${i}-last`).value;
            const email = document.getElementById(`m${i}-email`).value;
            const phone = document.getElementById(`m${i}-phone`).value;
            const member_id = document.getElementById(`m${i}-id`).value; // Get ID if editing

            if (!first_name || !last_name) {
                alert(`Member ${i}: First and Last Name are required.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Email validation (check if visual validation failed)
            const emailInput = document.getElementById(`m${i}-email`);
            if (emailInput.classList.contains('is-invalid')) {
                alert(`Member ${i}: Please fix the invalid email address.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Double check in case they submitted without blurring
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                alert(`Member ${i}: Please enter a valid email address.`);
                emailInput.classList.add('is-invalid');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            members.push({ member_id, first_name, last_name, email, phone });
        }

        if (members.length === 0) {
            alert("At least one household member is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        if (!household_name) {
            alert("Household name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { household_id, household_name, address, members };

        const handler = (res) => {
            // Handle Success (Create or Update)
            const existingIdx = STATE.households.findIndex(h => h.household_id === res.household_id);
            const newHousehold = {
                household_id: res.household_id,
                household_name: payload.household_name,
                address: address,
                members: members
                // Note: Newly created members won't have IDs here until refresh, 
                // but that's okay for UI display. Full refresh on page load fixes it.
                // Ideally we'd return full object from server.
            };

            if (existingIdx !== -1) {
                STATE.households[existingIdx] = newHousehold;
            } else {
                STATE.households.push(newHousehold);
            }

            // Refresh UI
            renderHouseholdsDirectory();
            initAutocomplete(); // Update search index
            renderFilters(); // Added to refresh household filters

            // Close Modal
            const modalEl = document.getElementById('addHouseholdModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Reset Form
            resetAddHouseholdModal();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', household_id ? 'Household updated successfully!' : 'Household added successfully!');
        };

        if (household_id) {
            // Update
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .updateHousehold(payload);
        } else {
            // Create
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .saveHousehold(payload);
        }
    }


    // --- DONATION FORM ---
    function setupHouseholdAutocomplete(config) {
        // config: { inputId, resultsId, hiddenId, membersId (optional), onSelect (optional), defaultText (optional) }
        const input = document.getElementById(config.inputId);
        const resultsList = document.getElementById(config.resultsId);
        const hiddenId = document.getElementById(config.hiddenId);
        const membersDisplay = config.membersId ? document.getElementById(config.membersId) : null;

        if (!input || !resultsList || !hiddenId) return;

        // Helper to clear selection
        const clearSelection = () => {
            hiddenId.value = 'All'; // Default for filters
            if (config.membersId && membersDisplay) membersDisplay.innerHTML = '';
        };

        input.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();

            // If empty, reset (mainly for filters)
            if (query.trim() === '') {
                clearSelection();
                if (config.onSelect) config.onSelect(null);
                resultsList.classList.add('d-none');
                return;
            }

            resultsList.innerHTML = '';
            resultsList.classList.add('d-none');
            if (membersDisplay) membersDisplay.innerHTML = '';

            if (query.length < 2) return;

            // Search logic
            const matches = STATE.households.filter(h =>
                (h.search_index || '').toLowerCase().includes(query) ||
                (h.household_name || '').toLowerCase().includes(query)
            ).slice(0, 5);

            if (matches.length > 0) {
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action cursor-pointer';
                    li.innerHTML = `
                        <strong>${escapeHtml(match.household_name)}</strong><br>
                        <small class="text-muted">${escapeHtml(formatHouseholdName(match.members))}</small>
                    `;

                    li.onclick = (ev) => {
                        ev.stopPropagation(); // Prevent document click handler
                        input.value = match.household_name; // Keep name in input
                        hiddenId.value = match.household_id;
                        resultsList.classList.add('d-none');
                        input.classList.add('is-valid');

                        // Display member info if requested
                        if (membersDisplay) {
                            const memberInfo = match.members.map(m =>
                                `${escapeHtml(m.first_name)} ${escapeHtml(m.last_name)}${m.email ? ` (${escapeHtml(m.email)})` : ''}`
                            ).join('<br>');
                            membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
                        }

                        if (config.onSelect) config.onSelect(match);
                    };

                    resultsList.appendChild(li);
                });
                resultsList.classList.remove('d-none');
            }
        });

        // Search on Focus (optional, maybe too noisy?)
        // input.addEventListener('focus', () => { ... });

        // Close on click outside
        document.addEventListener('click', (e) => {
            if (e.target !== input && e.target !== resultsList && !resultsList.contains(e.target)) {
                resultsList.classList.add('d-none');

                // If input has text but no ID is selected (user typed garbage), revert or clear?
                // For filters: explicit clear is better.
                // For Data Entry: we might want to leave it? 
                // Let's rely on hiddenId. If hiddenId is empty/All and text is present but not selected...
                // Ideally we force selection.
                const currentId = hiddenId.value;
                if (currentId === 'All' || currentId === '') {
                    // If they typed something but didn't select, and it's not a valid exact match...
                    // Maybe just leave it alone for now, user handles it.
                }
            }
        });
    }

    function initAutocomplete() {
        // 1. Donation Modal Autocomplete
        setupHouseholdAutocomplete({
            inputId: 'household-search',
            resultsId: 'results-list',
            hiddenId: 'selected-household-id',
            membersId: 'selected-household-members',
            onSelect: (household) => updateThankYouButtonState(household)
        });

        // 2. Donation Filter Autocomplete
        setupHouseholdAutocomplete({
            inputId: 'dm-filter-household-search',
            resultsId: 'dm-filter-household-results',
            hiddenId: 'dm-filter-household',
            onSelect: () => renderDonationsTable()
        });

        // 3. Export Filter Autocomplete (Will look for elements, safe if missing)
        setupHouseholdAutocomplete({
            inputId: 'export-filter-household-search',
            resultsId: 'export-filter-household-results',
            hiddenId: 'export-filter-household',
            onSelect: () => updateExportPreview() // Trigger preview update
        });
    }

    // --- EXPORT SORTING STATE ---
    let exportSort = {
        field: 'date',
        direction: 'desc'
    };

    function handleExportSort(field) {
        if (exportSort.field === field) {
            exportSort.direction = exportSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            exportSort.field = field;
            if (field === 'date' || field === 'amount') {
                exportSort.direction = 'desc';
            } else {
                exportSort.direction = 'asc';
            }
        }
        updateExportPreview();
    }

    function updateExportPreview() {
        // 1. Get Filters
        const startYear = parseInt(document.getElementById('export-filter-year-start').value);
        const endYear = parseInt(document.getElementById('export-filter-year-end').value);
        const householdFilter = document.getElementById('export-filter-household').value;
        const methodFilter = document.getElementById('export-filter-method').value;

        // 2. Identify Selection
        let selectedType = 'donations';
        if (document.getElementById('radio-export-households').checked) selectedType = 'households';
        if (document.getElementById('radio-export-projects').checked) selectedType = 'projects';
        if (document.getElementById('radio-export-mailchimp').checked) selectedType = 'mailchimp';

        // 3. Filter Data Logic
        // Always filter donations first as it drives time/method logic
        let filteredDonations = STATE.donations.filter(d => {
            const year = new Date(d.date).getFullYear();
            if (year < startYear || year > endYear) return false;
            if (householdFilter !== 'All' && d.household_id !== householdFilter) return false;
            if (methodFilter !== 'All' && d.method !== methodFilter) return false;
            return true;
        });

        const relevantHouseholdIds = new Set(filteredDonations.map(d => d.household_id));
        let filteredHouseholds = STATE.households.filter(h => {
            if (householdFilter !== 'All') return h.household_id === householdFilter;
            return relevantHouseholdIds.has(h.household_id);
        });

        // Projects (Keep All for now unless we implement deeper filtering)
        const filteredProjects = STATE.projects;

        // 4. Update Summaries & Total
        const countBadge = document.getElementById('preview-count-records');
        const totalBadge = document.getElementById('preview-total-donated');

        let displayData = [];
        let totalAmount = 0;
        let recordLabel = 'Records';

        if (selectedType === 'donations') {
            displayData = filteredDonations;
            recordLabel = 'Donations';
            totalAmount = filteredDonations.reduce((sum, d) => sum + d.amount_cents, 0);
            totalBadge.classList.remove('d-none');
        } else if (selectedType === 'households') {
            displayData = filteredHouseholds;
            recordLabel = 'Households';
            // Determine Total Donated for these households (in this period? or lifetime?)
            // User likely expects the sum of the filtered donations if that's what drove the household list.
            totalAmount = filteredDonations.reduce((sum, d) => sum + d.amount_cents, 0);
            totalBadge.classList.remove('d-none');
        } else if (selectedType === 'mailchimp') {
            displayData = getMailchimpExportData();
            recordLabel = 'Contacts';
            totalAmount = displayData.reduce((sum, r) => sum + (r.ltv * 100), 0); // LTV is in dollars
            totalBadge.classList.remove('d-none');
        } else {
            // Projects
            displayData = filteredProjects;
            recordLabel = 'Projects';
            totalBadge.classList.add('d-none');
        }

        countBadge.textContent = `${displayData.length} ${recordLabel}`;
        totalBadge.textContent = `Total: ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(totalAmount / 100)}`;

        // 5. Render Table (All filtered records)
        const thead = document.getElementById('preview-table-headers');
        const tbody = document.getElementById('export-preview-body');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (displayData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No ${recordLabel.toLowerCase()} match filters.</td></tr>`;
            document.getElementById('preview-footer').textContent = '';
            return;
        }

        // Sort data before rendering
        if (selectedType === 'donations') {
            displayData.sort((a, b) => {
                const field = exportSort.field;
                const dir = exportSort.direction === 'asc' ? 1 : -1;

                if (field === 'date') {
                    return (new Date(a.date) - new Date(b.date)) * dir;
                }
                if (field === 'amount') {
                    return (a.amount_cents - b.amount_cents) * dir;
                }

                let valA = '', valB = '';
                if (field === 'household') {
                    const hA = STATE.households.find(h => h.household_id === a.household_id);
                    const hB = STATE.households.find(h => h.household_id === b.household_id);
                    valA = hA ? hA.household_name : '';
                    valB = hB ? hB.household_name : '';
                } else if (field === 'project') {
                    const pA = STATE.projects.find(p => p.project_id === a.project_id);
                    const pB = STATE.projects.find(p => p.project_id === b.project_id);
                    valA = pA ? pA.name : '';
                    valB = pB ? pB.name : '';
                } else if (field === 'method') {
                    valA = a.method || '';
                    valB = b.method || '';
                }

                return valA.localeCompare(valB) * dir;
            });
        }

        // Helper to generate sortable header
        const sortIcon = (field) => {
            if (exportSort.field === field) {
                return exportSort.direction === 'asc' ? '<i class="bi bi-arrow-up-short"></i>' : '<i class="bi bi-arrow-down-short"></i>';
            }
            return '';
        };

        // Render all rows (relies on container overflow-y for scrolling)
        if (selectedType === 'donations') {
            thead.innerHTML = `
                <th class="sortable-header" onclick="handleExportSort('date')">Date ${sortIcon('date')}</th>
                <th class="sortable-header" onclick="handleExportSort('household')">Household ${sortIcon('household')}</th>
                <th class="sortable-header" onclick="handleExportSort('amount')">Amount ${sortIcon('amount')}</th>
                <th class="sortable-header" onclick="handleExportSort('method')">Method ${sortIcon('method')}</th>
                <th class="sortable-header" onclick="handleExportSort('project')">Project ${sortIcon('project')}</th>
            `;
            displayData.forEach(d => {
                const h = STATE.households.find(x => x.household_id === d.household_id);
                const p = STATE.projects.find(x => x.project_id === d.project_id);
                const amount = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(d.amount_cents / 100);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDateUS(d.date)}</td>
                    <td>${escapeHtml(h ? h.household_name : 'Unknown')}</td>
                    <td>${amount}</td>
                    <td>${escapeHtml(d.method)}</td>
                    <td>${escapeHtml(p ? p.name : '')}</td>
                `;
                tbody.appendChild(tr);
            });
        } else if (selectedType === 'households') {
            thead.innerHTML = '<th>Household Name</th><th>Members</th><th>Email</th><th>Address</th>';
            displayData.forEach(h => {
                const members = h.members.map(m => `${m.first_name} ${m.last_name}`).join('; ');
                const emails = h.members.map(m => m.email).filter(e => e).join('; ');
                // Build address with Zip+4
                let address = '';
                if (h.address) {
                    const parts = [];
                    if (h.address.city) parts.push(h.address.city);
                    if (h.address.state) parts.push(h.address.state);
                    let zip = h.address.zip || '';
                    if (h.address.zip4) zip += '-' + h.address.zip4;
                    if (zip) parts.push(zip);
                    address = parts.join(', ');
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(h.household_name)}</td>
                    <td>${escapeHtml(members)}</td>
                    <td>${escapeHtml(emails)}</td>
                    <td>${escapeHtml(address)}</td>
                `;
                tbody.appendChild(tr);
            });
        } else if (selectedType === 'mailchimp') {
            thead.textContent = '';
            ['Email', 'Name', 'LAST_GIFT', 'LTV', 'Tags'].forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                thead.appendChild(th);
            });
            displayData.forEach(r => {
                const tr = document.createElement('tr');
                const lastGiftFormatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(r.lastGift);
                const ltvFormatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(r.ltv);

                const tdEmail = document.createElement('td');
                tdEmail.textContent = r.email;
                tr.appendChild(tdEmail);

                const tdName = document.createElement('td');
                tdName.textContent = r.firstName + ' ' + r.lastName;
                tr.appendChild(tdName);

                const tdLastGift = document.createElement('td');
                tdLastGift.textContent = lastGiftFormatted;
                tr.appendChild(tdLastGift);

                const tdLtv = document.createElement('td');
                tdLtv.textContent = ltvFormatted;
                tr.appendChild(tdLtv);

                const tdTags = document.createElement('td');
                const small = document.createElement('small');
                small.className = 'text-muted';
                small.textContent = r.tags;
                tdTags.appendChild(small);
                tr.appendChild(tdTags);

                tbody.appendChild(tr);
            });
        } else {
            // Projects
            thead.textContent = '';
            ['Project Name', 'Description'].forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                thead.appendChild(th);
            });
            displayData.forEach(p => {
                const tr = document.createElement('tr');
                const tdName = document.createElement('td');
                tdName.textContent = p.name;
                tr.appendChild(tdName);
                const tdDesc = document.createElement('td');
                tdDesc.textContent = p.description || '-';
                tr.appendChild(tdDesc);
                tbody.appendChild(tr);
            });
        }

        const footer = document.getElementById('preview-footer');
        footer.textContent = `Showing all ${displayData.length} records`;
    }

    function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    }

    function showError(err) {
        console.error(err);
        showAlert('danger', 'System Error: ' + err.message);
    }
    // --- EXPORT FUNCTIONALITY ---

    /**
     * Build Mailchimp-ready export data
     * Groups donations by email, calculates LAST_GIFT, GIFT_DATE, LTV, FIRST_GIFT
     * Auto-generates year tags from donation dates
     */
    function getMailchimpExportData() {
        const startYear = parseInt(document.getElementById('export-filter-year-start').value);
        const endYear = parseInt(document.getElementById('export-filter-year-end').value);
        const householdFilter = document.getElementById('export-filter-household').value;
        const methodFilter = document.getElementById('export-filter-method').value;

        // Filter donations by year range and filters
        let filteredDonations = STATE.donations.filter(d => {
            const year = new Date(d.date).getFullYear();
            if (year < startYear || year > endYear) return false;
            if (householdFilter !== 'All' && d.household_id !== householdFilter) return false;
            if (methodFilter !== 'All' && d.method !== methodFilter) return false;
            return true;
        });

        // Get relevant household IDs from filtered donations
        const relevantHouseholdIds = new Set(filteredDonations.map(d => d.household_id));

        // Build map: email -> { member, household, donations[] }
        const emailMap = {};

        STATE.households.forEach(h => {
            if (!relevantHouseholdIds.has(h.household_id)) return;

            // Get ALL donations for this household (for LTV calculation)
            const householdDonations = STATE.donations.filter(d => d.household_id === h.household_id);
            // Get filtered donations for tags
            const filteredHouseholdDonations = filteredDonations.filter(d => d.household_id === h.household_id);

            h.members.forEach(m => {
                if (!m.email) return; // Skip members without email

                const email = m.email.toLowerCase().trim();
                if (!emailMap[email]) {
                    emailMap[email] = {
                        email: m.email,
                        firstName: m.first_name || '',
                        lastName: m.last_name || '',
                        address: h.address || {},
                        donations: householdDonations,
                        filteredDonations: filteredHouseholdDonations
                    };
                } else {
                    // Merge donations if same email appears in multiple households
                    emailMap[email].donations = emailMap[email].donations.concat(householdDonations);
                    emailMap[email].filteredDonations = emailMap[email].filteredDonations.concat(filteredHouseholdDonations);
                }
            });
        });

        // Convert to array and calculate metrics
        const results = Object.values(emailMap).map(entry => {
            const allDonations = entry.donations;
            const filteredDons = entry.filteredDonations;

            if (filteredDons.length === 0) return null; // No donations in filter range

            // Sort by date for calculations
            const sortedByDate = [...allDonations].sort((a, b) => new Date(b.date) - new Date(a.date));
            const oldestFirst = [...allDonations].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Calculate metrics
            const lastGift = sortedByDate.length > 0 ? sortedByDate[0].amount_cents / 100 : 0;
            const lastGiftDate = sortedByDate.length > 0 ? sortedByDate[0].date : null;
            const firstGiftDate = oldestFirst.length > 0 ? oldestFirst[0].date : null;
            const ltv = allDonations.reduce((sum, d) => sum + d.amount_cents, 0) / 100;

            // Generate year tags from filtered donations
            const years = new Set(filteredDons.map(d => new Date(d.date).getFullYear()));
            const tags = Array.from(years).sort((a, b) => b - a).map(y => `Donor-${y}`).join(', ');

            return {
                email: entry.email,
                firstName: entry.firstName,
                lastName: entry.lastName,
                lastGift: lastGift,
                giftDate: lastGiftDate ? formatDateUS(lastGiftDate) : '',
                ltv: ltv,
                firstGift: firstGiftDate ? formatDateUS(firstGiftDate) : '',
                street: entry.address.street || '',
                city: entry.address.city || '',
                state: entry.address.state || '',
                zip: entry.address.zip || '',
                tags: tags
            };
        }).filter(r => r !== null);

        // Sort by email for consistent output
        results.sort((a, b) => a.email.localeCompare(b.email));

        return results;
    }

    // Helper: Format address with Zip+4
    function formatAddress(h) {
        if (!h.address) return '';
        const parts = [h.address.street];
        if (h.address.street2) parts.push(h.address.street2);
        if (h.address.city) parts.push(h.address.city);
        if (h.address.state) parts.push(h.address.state);
        let zip = h.address.zip || '';
        if (h.address.zip4) zip += '-' + h.address.zip4;
        if (zip) parts.push(zip);
        return parts.join(', ');
    }

    // Helper: Get filtered data based on current filter settings
    function getFilteredExportData() {
        const startYear = parseInt(document.getElementById('export-filter-year-start').value);
        const endYear = parseInt(document.getElementById('export-filter-year-end').value);
        const householdFilter = document.getElementById('export-filter-household').value;
        const methodFilter = document.getElementById('export-filter-method').value;

        let selectedType = 'donations';
        if (document.getElementById('radio-export-households').checked) selectedType = 'households';
        if (document.getElementById('radio-export-projects').checked) selectedType = 'projects';
        if (document.getElementById('radio-export-mailchimp').checked) selectedType = 'mailchimp';

        let filteredDonations = STATE.donations.filter(d => {
            const year = new Date(d.date).getFullYear();
            return year >= startYear && year <= endYear;
        });

        if (householdFilter !== 'All') {
            filteredDonations = filteredDonations.filter(d => d.household_id === householdFilter);
        }
        if (methodFilter !== 'All') {
            filteredDonations = filteredDonations.filter(d => d.method === methodFilter);
        }

        const relevantHouseholdIds = new Set(filteredDonations.map(d => d.household_id));
        let filteredHouseholds = STATE.households.filter(h => {
            if (householdFilter !== 'All') return h.household_id === householdFilter;
            return relevantHouseholdIds.has(h.household_id);
        });

        // Sort donations based on current export sort settings
        filteredDonations.sort((a, b) => {
            const field = exportSort.field;
            const dir = exportSort.direction === 'asc' ? 1 : -1;

            if (field === 'date') {
                return (new Date(a.date) - new Date(b.date)) * dir;
            }
            if (field === 'amount') {
                return (a.amount_cents - b.amount_cents) * dir;
            }

            let valA = '', valB = '';
            if (field === 'household') {
                const hA = STATE.households.find(h => h.household_id === a.household_id);
                const hB = STATE.households.find(h => h.household_id === b.household_id);
                valA = hA ? hA.household_name : '';
                valB = hB ? hB.household_name : '';
            } else if (field === 'project') {
                const pA = STATE.projects.find(p => p.project_id === a.project_id);
                const pB = STATE.projects.find(p => p.project_id === b.project_id);
                valA = pA ? pA.name : '';
                valB = pB ? pB.name : '';
            } else if (field === 'method') {
                valA = a.method || '';
                valB = b.method || '';
            }

            return valA.localeCompare(valB) * dir;
        });

        return { selectedType, filteredDonations, filteredHouseholds, filteredProjects: STATE.projects };
    }

    // Main export function - supports both CSV and XLSX
    function exportData(format) {
        const { selectedType, filteredDonations, filteredHouseholds, filteredProjects } = getFilteredExportData();

        let data, headers, filename;

        if (selectedType === 'households') {
            headers = ['Household Name', 'Members', 'Email Addresses', 'Address'];
            data = filteredHouseholds.map(h => [
                h.household_name,
                h.members.map(m => `${m.first_name} ${m.last_name}`).join('; '),
                h.members.map(m => m.email).filter(e => e).join('; '),
                formatAddress(h)
            ]);
            filename = 'Donors';
        } else if (selectedType === 'donations') {
            headers = ['Date', 'Household Name', 'Amount', 'Method', 'Project'];
            data = filteredDonations.map(d => {
                const h = STATE.households.find(x => x.household_id === d.household_id);
                const p = STATE.projects.find(x => x.project_id === d.project_id);
                return [
                    formatDateUS(d.date),
                    h ? h.household_name : 'Unknown',
                    Math.round(d.amount_cents / 100),
                    d.method,
                    p ? p.name : ''
                ];
            });
            filename = 'Donations';
        } else if (selectedType === 'mailchimp') {
            headers = ['Email Address', 'First Name', 'Last Name', 'LAST_GIFT', 'GIFT_DATE', 'LTV', 'FIRST_GIFT', 'Address', 'City', 'State', 'Zip', 'Tags'];
            const mailchimpData = getMailchimpExportData();
            data = mailchimpData.map(r => [
                r.email,
                r.firstName,
                r.lastName,
                r.lastGift,
                r.giftDate,
                r.ltv,
                r.firstGift,
                r.street,
                r.city,
                r.state,
                r.zip,
                r.tags
            ]);
            filename = 'Mailchimp_Import';
        } else {
            headers = ['ID', 'Name', 'Description'];
            data = filteredProjects.map(p => [p.project_id, p.name, p.description || '']);
            filename = 'Projects';
        }

        if (data.length === 0) {
            showAlert('warning', 'No records to export with the current filters.');
            return;
        }

        if (format === 'xlsx') {
            exportToXLSX(data, headers, filename, selectedType);
        } else {
            exportToCSV(data, headers, filename);
        }
    }

    // Export to XLSX with formatting
    function exportToXLSX(data, headers, filename, dataType) {
        const wb = XLSX.utils.book_new();
        const wsData = [headers, ...data];
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Set column widths based on data type
        if (dataType === 'donations') {
            ws['!cols'] = [
                { wch: 12 },  // Date
                { wch: 30 },  // Household Name
                { wch: 12 },  // Amount
                { wch: 15 },  // Method
                { wch: 25 }   // Project
            ];
            // Apply currency format to Amount column (column C, index 2)
            // Format code "$#,##0" = currency with no decimals
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = 1; row <= range.e.r; row++) {  // Skip header row
                const cellRef = XLSX.utils.encode_cell({ r: row, c: 2 });
                if (ws[cellRef]) {
                    ws[cellRef].z = '"$"#,##0';
                }
            }
        } else if (dataType === 'households') {
            ws['!cols'] = [
                { wch: 30 },  // Household Name
                { wch: 35 },  // Members
                { wch: 35 },  // Email Addresses
                { wch: 50 }   // Address
            ];
        } else if (dataType === 'mailchimp') {
            ws['!cols'] = [
                { wch: 30 },  // Email Address
                { wch: 15 },  // First Name
                { wch: 15 },  // Last Name
                { wch: 12 },  // LAST_GIFT
                { wch: 12 },  // GIFT_DATE
                { wch: 12 },  // LTV
                { wch: 12 },  // FIRST_GIFT
                { wch: 25 },  // Address
                { wch: 15 },  // City
                { wch: 8 },   // State
                { wch: 10 },  // Zip
                { wch: 30 }   // Tags
            ];
            // Apply currency format to LAST_GIFT (col 3) and LTV (col 5)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = 1; row <= range.e.r; row++) {
                const lastGiftCell = XLSX.utils.encode_cell({ r: row, c: 3 });
                const ltvCell = XLSX.utils.encode_cell({ r: row, c: 5 });
                if (ws[lastGiftCell]) ws[lastGiftCell].z = '"$"#,##0';
                if (ws[ltvCell]) ws[ltvCell].z = '"$"#,##0';
            }
        } else {
            ws['!cols'] = [
                { wch: 10 },  // ID
                { wch: 30 },  // Name
                { wch: 50 }   // Description
            ];
        }

        XLSX.utils.book_append_sheet(wb, ws, dataType.charAt(0).toUpperCase() + dataType.slice(1));
        XLSX.writeFile(wb, `${filename}.xlsx`);
    }

    // Export to CSV (legacy support)
    function exportToCSV(data, headers, filename) {
        const escape = (val) => {
            if (val === null || val === undefined) return '';
            const str = String(val).replace(/"/g, '""');
            return `"${str}"`;
        };

        const headerRow = headers.map(escape).join(',');
        const rows = data.map(row => row.map(escape).join(','));
        const csvContent = [headerRow, ...rows].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${filename}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }


    // --- SORTING STATE ---
    let currentSort = {
        field: 'date',
        direction: 'desc'
    };

    function handleSort(field) {
        if (currentSort.field === field) {
            // Toggle
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            // New field
            currentSort.field = field;
            // Default directions
            if (field === 'date' || field === 'amount') {
                currentSort.direction = 'desc';
            } else {
                currentSort.direction = 'asc';
            }
        }
        renderDonationsTable();
    }

    function resetDonationFilters() {
        // Reset Year Mode to Current
        const modeSel = document.getElementById('dm-filter-year-mode');
        if (modeSel) {
            const currentYear = new Date().getFullYear().toString();
            // Check if current year is in list, else first option
            if (Array.from(modeSel.options).some(o => o.value === currentYear)) {
                modeSel.value = currentYear;
            } else if (modeSel.options.length > 0) {
                modeSel.value = modeSel.options[0].value;
            }
            handleYearModeChange('donations', true); // Sync hidden fields
        }

        document.getElementById('dm-filter-household').value = 'All';
        const hhSearch = document.getElementById('dm-filter-household-search');
        if (hhSearch) hhSearch.value = ''; // Clear text input

        document.getElementById('dm-filter-method').value = 'All';
        window.donationProjectFilter = null; // Clear override

        // Reset Sort
        currentSort = { field: 'date', direction: 'desc' };

        renderDonationsTable();
    }

    function renderDonationsTable() {
        // 1. Get Filters
        const startYear = parseInt(document.getElementById('dm-filter-year-start').value);
        const endYear = parseInt(document.getElementById('dm-filter-year-end').value);
        const householdId = document.getElementById('dm-filter-household').value;
        const method = document.getElementById('dm-filter-method').value;

        // 2. Filter Data
        let filtered = STATE.donations.filter(d => {
            const dYear = new Date(d.date).getFullYear();
            if (dYear < startYear || dYear > endYear) return false;

            if (householdId !== 'All' && d.household_id !== householdId) return false;
            if (method !== 'All' && d.method !== method) return false;

            // Check for transient Project override (from drill-down)
            if (window.donationProjectFilter && d.project_id !== window.donationProjectFilter) return false;

            return true;
        });

        // Clear transient filter after use? 
        // If we clear it, re-rendering (e.g. changing year) will lose the project filter.
        // So we should NOT clear it unless the user explicitly resets or navigates away.
        // Ideally we'd show UI for it, but for now invisible persistence is acceptable for this Drill-down feature.

        // 3. Render Global Summary
        const summaryContainer = document.getElementById('donations-summary');
        if (summaryContainer) {
            const totalCents = filtered.reduce((sum, d) => sum + d.amount_cents, 0);
            const totalCount = filtered.length;

            // Breakdowns
            const byProject = {};
            const byMethod = {};

            filtered.forEach(d => {
                const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'Unknown';
                if (!byProject[pName]) byProject[pName] = { count: 0, cents: 0 };
                byProject[pName].count++;
                byProject[pName].cents += d.amount_cents;

                if (!byMethod[d.method]) byMethod[d.method] = { count: 0, cents: 0 };
                byMethod[d.method].count++;
                byMethod[d.method].cents += d.amount_cents;
            });

            // Generate Summary HTML
            const formatMoney = (cents) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(cents / 100);

            let projectSummaryHtml = Object.entries(byProject).map(([name, stats]) =>
                `<div><small class="text-muted">${name}:</small> <strong>${formatMoney(stats.cents)}</strong> <span class="text-muted">(${stats.count})</span></div>`
            ).join('');

            let methodSummaryHtml = Object.entries(byMethod).map(([name, stats]) =>
                `<div class="me-3"><small class="text-muted">${name}:</small> <strong>${formatMoney(stats.cents)}</strong> <span class="text-muted">(${stats.count})</span></div>`
            ).join('');

            summaryContainer.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card bg-gradient-primary-soft border-0 shadow-sm h-100 border-left-primary">
                            <div class="card-body">
                                <span class="text-primary small text-uppercase fw-bold">Total Raised</span>
                                <div class="fs-4 fw-bold text-dark mt-1">${formatMoney(totalCents)}</div>
                                <div class="small text-muted">${totalCount} donations</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-white border-0 shadow-sm h-100 border-left-info">
                            <div class="card-body">
                                <span class="text-info small text-uppercase fw-bold mb-2 d-block">By Project</span>
                                <div class="d-flex flex-column gap-1 small text-dark">${projectSummaryHtml || '<span class="text-muted">-</span>'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-white border-0 shadow-sm h-100 border-left-success">
                            <div class="card-body">
                                <span class="text-success small text-uppercase fw-bold mb-2 d-block">By Method</span>
                                <div class="d-flex flex-wrap gap-2 small text-dark">${methodSummaryHtml || '<span class="text-muted">-</span>'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // 4. Sort Data
        filtered.sort((a, b) => {
            const field = currentSort.field;
            const dir = currentSort.direction === 'asc' ? 1 : -1;

            if (field === 'date') {
                return (new Date(a.date) - new Date(b.date)) * dir;
            }
            if (field === 'amount') {
                return (a.amount_cents - b.amount_cents) * dir;
            }

            // Text Compares
            let valA = '', valB = '';

            if (field === 'household') {
                const hA = STATE.households.find(h => h.household_id === a.household_id);
                const hB = STATE.households.find(h => h.household_id === b.household_id);
                valA = hA ? hA.household_name : '';
                valB = hB ? hB.household_name : '';
            }
            else if (field === 'project') {
                const pA = STATE.projects.find(p => p.project_id === a.project_id);
                const pB = STATE.projects.find(p => p.project_id === b.project_id);
                valA = pA ? pA.name : '';
                valB = pB ? pB.name : '';
            }
            else if (field === 'method') {
                valA = a.method || '';
                valB = b.method || '';
            }

            return valA.localeCompare(valB) * dir;
        });

        // 5. Update Header Icons
        ['date', 'household', 'amount', 'project', 'method'].forEach(f => {
            const icon = document.getElementById(`sort-icon-${f}`);
            if (icon) {
                if (currentSort.field === f) {
                    icon.className = currentSort.direction === 'asc' ? 'bi bi-arrow-up-short' : 'bi bi-arrow-down-short';
                } else {
                    icon.className = '';
                }
            }
        });


        // 6. Render Table Rows
        const tbody = document.getElementById('donations-table-body');
        tbody.innerHTML = '';
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No donations found matching criteria.</td></tr>';
            return;
        }

        const formatMoney = (cents) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(cents / 100);

        filtered.forEach(d => {
            const h = STATE.households.find(hh => hh.household_id === d.household_id) || { household_name: 'Unknown Household' };
            const p = STATE.projects.find(pp => pp.project_id === d.project_id) || { name: 'Unknown Project' };

            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${formatDateUS(d.date)}</td>
            <td><a href="#" onclick="viewHouseholdDonations('${escapeHtml(d.household_id)}'); return false;">${escapeHtml(h.household_name)}</a></td>
            <td>${formatMoney(d.amount_cents)}</td>
            <td>${escapeHtml(p.name)}</td>
            <td>${escapeHtml(d.method)}</td>
            <td class="text-end">
                <button class="btn btn-sm btn-link text-primary" onclick="openDonationModal('${d.txn_id}')"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-link text-danger" onclick="deleteDonation('${d.txn_id}')"><i class="bi bi-trash"></i></button>
            </td>
        `;
            tbody.appendChild(tr);
        });
    }



    function renderHouseholdMembersPreview(members) {
        if (!members || members.length === 0) return;
        const membersDisplay = document.getElementById('selected-household-members');
        const memberInfo = members.map(m =>
            `${m.first_name} ${m.last_name}${m.email ? ` (${m.email})` : ''}`
        ).join('<br>');
        membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
    }

    let donationModal = null; // Store Bootstrap Modal instance

    function openDonationModal(txn_id = null) {
        if (!donationModal) {
            donationModal = new bootstrap.Modal(document.getElementById('donationModal'));
        }

        const form = document.getElementById('donation-form');
        // Reset Validations
        document.getElementById('household-search').classList.remove('is-valid');
        document.getElementById('selected-household-members').innerHTML = '';

        if (txn_id) {
            // EDIT MODE
            const donation = STATE.donations.find(d => d.txn_id === txn_id);
            if (!donation) return;

            document.getElementById('donationModalLabel').innerText = 'Edit Donation';
            document.getElementById('donation-txn-id').value = donation.txn_id;

            // Pre-fill fields
            const household = STATE.households.find(h => h.household_id === donation.household_id);
            document.getElementById('household-search').value = household ? household.household_name : '';
            document.getElementById('selected-household-id').value = donation.household_id;
            document.getElementById('amount').value = donation.amount_cents / 100;

            // Format date for input type="date" (YYYY-MM-DD)
            const d = new Date(donation.date);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

            document.getElementById('project').value = donation.project_id || '';
            document.getElementById('method').value = donation.method;
            document.getElementById('comments').value = donation.comments || '';

            // Populate deposit date if set
            if (donation.deposit_date) {
                const dep = new Date(donation.deposit_date);
                const depYyyy = dep.getFullYear();
                const depMm = String(dep.getMonth() + 1).padStart(2, '0');
                const depDd = String(dep.getDate()).padStart(2, '0');
                document.getElementById('deposit-date').value = `${depYyyy}-${depMm}-${depDd}`;
            } else {
                document.getElementById('deposit-date').value = '';
            }

            // Show entry date/time (read-only audit field)
            if (donation.entry_date) {
                document.getElementById('entry-date-group').classList.remove('d-none');
                document.getElementById('entry-date').value = formatDateTimeUS(donation.entry_date);
            } else {
                document.getElementById('entry-date-group').classList.add('d-none');
            }

            // Show members preview
            if (household) {
                renderHouseholdMembersPreview(household.members);
                updateThankYouButtonState(household);
            }

        } else {
            // ADD MODE
            document.getElementById('donationModalLabel').innerText = 'Log New Donation';
            document.getElementById('donation-txn-id').value = ''; // Empty for new
            form.reset();
            document.getElementById('selected-household-id').value = '';
            document.getElementById('date').valueAsDate = new Date();
            // Default project to "General Fund"
            const generalFund = STATE.projects.find(p => p.name === 'General Fund');
            if (generalFund) {
                document.getElementById('project').value = generalFund.project_id;
            }
            // Clear deposit date (optional for new donations)
            document.getElementById('deposit-date').value = '';
            // Hide entry date (will be auto-set on save)
            document.getElementById('entry-date-group').classList.add('d-none');
            // Reset thank you button state
            updateThankYouButtonState(null);
        }

        donationModal.show();
    }

    function submitDonation() {
        const btn = document.getElementById('submit-donation-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const txnId = document.getElementById('donation-txn-id').value;
        const householdId = document.getElementById('selected-household-id').value;
        const project = document.getElementById('project').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        const method = document.getElementById('method').value;

        if (!householdId) {
            alert('Please select a household from the search list.');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const depositDate = document.getElementById('deposit-date').value;

        const payload = {
            txn_id: txnId, // Will be empty if new
            household_id: householdId,
            project_id: project,
            amount_cents: Math.round(amount * 100),
            date: date,
            method: method,
            comments: document.getElementById('comments').value,
            deposit_date: depositDate || ''
        };

        const successHandler = (res) => {
            btn.disabled = false;
            btn.textContent = originalText;

            // Close Modal
            if (donationModal) donationModal.hide();

            // Update Local State
            if (txnId) { // Update
                const idx = STATE.donations.findIndex(d => d.txn_id === txnId);
                if (idx !== -1) STATE.donations[idx] = payload;
            } else { // Create
                payload.txn_id = res.txn_id;
                payload.entry_date = res.entry_date;
                STATE.donations.push(payload);
            }

            // Refresh Views
            renderDonationsTable();
            renderDashboard();
            renderFilters(); // Added to refresh year/household filters
            showAlert('success', txnId ? 'Donation updated!' : 'Donation logged successfully!');
        };

        const failureHandler = (err) => {
            btn.disabled = false;
            btn.textContent = originalText;
            alert('Error: ' + err.message);
        };

        if (txnId) {
            google.script.run
                .withSuccessHandler(successHandler)
                .withFailureHandler(failureHandler)
                .updateDonation(payload);
        } else {
            google.script.run
                .withSuccessHandler(successHandler)
                .withFailureHandler(failureHandler)
                .saveDonation(payload);
        }
    }

    function deleteDonation(txn_id) {
        if (!confirm('Are you sure you want to delete this donation? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                // Update State
                STATE.donations = STATE.donations.filter(d => d.txn_id !== txn_id);
                // Refresh Views
                renderDonationsTable();
                renderDashboard();
                renderFilters(); // Added to refresh filters
                showAlert('success', 'Donation deleted.');
            })
            .withFailureHandler((err) => {
                alert('Error deleting donation: ' + err.message);
            })
            .deleteDonation(txn_id);
    }

    // --- THANK YOU LETTER FUNCTIONS ---
    let thankYouModal = null;
    let currentThankYouData = null;

    const DEFAULT_THANK_YOU_MESSAGE = `Dear {donor_name},

Thank you so much for your generous donation of {amount} to {organization}!

Your contribution on {date}{project} makes a real difference in our community. We are deeply grateful for your support and commitment to our mission.

Your generosity helps us continue our important work, and we couldn't do it without supporters like you.

With sincere gratitude,
The {organization} Team`;

    function updateThankYouButtonState(household) {
        const btn = document.getElementById('send-thank-you-btn');
        const hint = document.getElementById('thank-you-hint');

        if (!btn) return;

        // Check if household has any member with an email
        const hasEmail = household && household.members &&
            household.members.some(m => m.email && m.email.trim() !== '');

        btn.disabled = !hasEmail;

        if (hasEmail) {
            hint.textContent = 'Send a thank you email to this donor';
            hint.classList.remove('text-muted');
            hint.classList.add('text-success');
        } else {
            hint.textContent = 'Select a household with an email to enable';
            hint.classList.remove('text-success');
            hint.classList.add('text-muted');
        }
    }

    function openThankYouModal() {
        if (!thankYouModal) {
            thankYouModal = new bootstrap.Modal(document.getElementById('thankYouModal'));
        }

        // Get current donation form data
        const householdId = document.getElementById('selected-household-id').value;
        const household = STATE.households.find(h => h.household_id === householdId);

        if (!household) {
            alert('Please select a household first.');
            return;
        }

        // Get emails from household members
        const emails = household.members
            .filter(m => m.email && m.email.trim() !== '')
            .map(m => m.email.trim());

        if (emails.length === 0) {
            alert('No email addresses found for this household.');
            return;
        }

        // Get donation details from form
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const date = document.getElementById('date').value;  // Donation Date
        const depositDate = document.getElementById('deposit-date').value;  // Deposit Date
        const entryDate = document.getElementById('entry-date').value;  // Entry Date (from edit mode)
        const projectId = document.getElementById('project').value;
        const project = STATE.projects.find(p => p.project_id === projectId);

        // Generate donor name from household members
        const donorName = formatHouseholdName(household.members) || household.household_name;

        // Store current data for sending (all three date fields available)
        currentThankYouData = {
            recipients: emails,
            donorName: donorName,
            amount: amount,
            date: date,              // Donation Date - when the donor gave
            entryDate: entryDate,    // Entry Date - when logged (read-only)
            depositDate: depositDate, // Deposit Date - internal tracking
            projectName: project ? project.name : null,
            householdName: household.household_name
        };

        // Update recipients display
        document.getElementById('thank-you-recipients').textContent = emails.join(', ');

        // Set default message with placeholders
        document.getElementById('thank-you-message').value = DEFAULT_THANK_YOU_MESSAGE;

        // Update preview
        updateThankYouPreview();

        // Add event listener for live preview updates
        document.getElementById('thank-you-message').oninput = updateThankYouPreview;
        document.getElementById('thank-you-subject').oninput = updateThankYouPreview;

        thankYouModal.show();
    }

    function updateThankYouPreview() {
        if (!currentThankYouData) return;

        const messageTemplate = document.getElementById('thank-you-message').value;
        const preview = document.getElementById('thank-you-preview');

        // Format amount
        const formattedAmount = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0
        }).format(currentThankYouData.amount);

        // Format all three date fields
        const formattedDate = currentThankYouData.date ? formatDateUS(currentThankYouData.date) : 'N/A';
        const formattedEntryDate = currentThankYouData.entryDate || 'N/A';
        const formattedDepositDate = currentThankYouData.depositDate ? formatDateUS(currentThankYouData.depositDate) : 'N/A';

        // Project text (only add if there's a project)
        const projectText = currentThankYouData.projectName
            ? ` toward ${currentThankYouData.projectName}`
            : '';

        // Replace placeholders
        // Available: {date} = Donation Date, {entry_date} = Entry Date, {deposit_date} = Deposit Date
        let previewText = messageTemplate
            .replace(/\{donor_name\}/g, currentThankYouData.donorName)
            .replace(/\{amount\}/g, formattedAmount)
            .replace(/\{date\}/g, formattedDate)
            .replace(/\{entry_date\}/g, formattedEntryDate)
            .replace(/\{deposit_date\}/g, formattedDepositDate)
            .replace(/\{project\}/g, projectText)
            .replace(/\{organization\}/g, 'Southwest Corridor Park Conservancy');

        preview.textContent = previewText;
    }

    function sendThankYouEmail() {
        if (!currentThankYouData) {
            alert('No data available. Please try again.');
            return;
        }

        const btn = document.getElementById('send-thank-you-confirm-btn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

        const subject = document.getElementById('thank-you-subject').value;
        const messageTemplate = document.getElementById('thank-you-message').value;

        // Get the processed message from preview
        const processedMessage = document.getElementById('thank-you-preview').textContent;

        const payload = {
            recipients: currentThankYouData.recipients,
            subject: subject,
            body: processedMessage,
            householdName: currentThankYouData.householdName
        };

        google.script.run
            .withSuccessHandler((res) => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                thankYouModal.hide();
                showAlert('success', 'Thank you email sent successfully!');
            })
            .withFailureHandler((err) => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                alert('Error sending email: ' + err.message);
            })
            .sendThankYouEmail(payload);
    }
</script>