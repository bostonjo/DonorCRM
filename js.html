<script>
    let STATE = { households: [], projects: [], donations: [] };
    let CHARTS = {}; // Store chart instances

    window.onload = function () {
        document.getElementById('date').valueAsDate = new Date();
        google.script.run
            .withSuccessHandler(initApp)
            .withFailureHandler(showError)
            .getInitialData();
    };

    function initApp(resp) {
        console.log('initApp started with response:', resp);
        try {
            if (!resp) throw new Error("No response received from backend");
            if (resp.status === 'error') throw new Error("Server Error: " + resp.message);
            if (!resp.data) throw new Error("Response is missing data payload");

            const data = resp.data;

            STATE.households = data.households || [];
            STATE.projects = data.projects || [];
            STATE.donations = data.donations || [];

            renderFilters();

            // Populate Projects Dropdown (Modal)
            // ... (rest of function)

            const projectSelect = document.getElementById('project');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">No Project</option>';
                STATE.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.project_id;
                    option.textContent = p.name;
                    projectSelect.appendChild(option);
                });
            } else {
                console.warn('Project dropdown not found');
            }

            initAutocomplete();
            renderHouseholdsDirectory();
            renderProjectsDirectory();
            try { renderDashboard(); } catch (e) { console.warn('Dashboard render failed', e); }
            try { renderDonationsTable(); } catch (e) { console.warn('Donations table render failed', e); }

            // Initialize auto-naming
            setupHouseholdAutoNaming();

        } catch (error) {
            console.error('CRITICAL INIT ERROR:', error);
            showError(error);
        }
    }

    function renderFilters() {
        // Initialize Year Range Selects (Dashboard & Donations)
        const selects = [
            document.getElementById('filter-year-start'),
            document.getElementById('filter-year-end'),
            document.getElementById('dm-filter-year-start'),
            document.getElementById('dm-filter-year-end')
        ];

        const years = [...new Set(STATE.donations.map(d => new Date(d.date).getFullYear()))].sort(); // Ascending
        if (years.length === 0) {
            const y = new Date().getFullYear();
            years.push(y);
        }

        const minYear = years[0];
        const maxYear = new Date().getFullYear(); // Ensure current year is always available even if no donations
        if (!years.includes(maxYear)) years.push(maxYear);
        years.sort((a, b) => a - b);

        selects.forEach(sel => {
            if (!sel) return;
            const currentVal = sel.value;
            sel.innerHTML = '';

            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                sel.appendChild(opt);
            });

            // Restore or Default
            if (currentVal && years.includes(parseInt(currentVal))) {
                sel.value = currentVal;
            } else {
                // Default logic: 
                // Start years -> minYear
                // End years -> maxYear
                if (sel.id.includes('start')) sel.value = minYear;
                if (sel.id.includes('end')) sel.value = maxYear;
            }
        });

        // Populate Filter Projects (Dashboard)
        const filterProject = document.getElementById('filter-project');
        if (filterProject) {
            const currentProj = filterProject.value;
            filterProject.innerHTML = '<option value="All">All Projects</option>';
            STATE.projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.project_id;
                option.textContent = p.name;
                filterProject.appendChild(option);
            });
            filterProject.value = currentProj;
            if (filterProject.value !== currentProj) filterProject.value = 'All';
        }

        // Populate Donation Management Household Filter
        const dmHouseholdSelect = document.getElementById('dm-filter-household');
        if (dmHouseholdSelect) {
            const currentH = dmHouseholdSelect.value;
            dmHouseholdSelect.innerHTML = '<option value="All">All Households</option>';
            const sortedHouseholds = [...STATE.households].sort((a, b) => (a.household_name || '').localeCompare(b.household_name || ''));
            sortedHouseholds.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.household_id;
                opt.textContent = h.household_name;
                dmHouseholdSelect.appendChild(opt);
            });
            dmHouseholdSelect.value = currentH;
            if (dmHouseholdSelect.value !== currentH) dmHouseholdSelect.value = 'All';
        }
    }



    // --- NAVIGATION ---
    // --- NAVIGATION ---
    // --- NAVIGATION ---
    window.switchView = function (viewId, linkElement) {
        // 1. Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));

        // 2. Show target
        const target = document.getElementById(viewId);
        if (target) {
            target.classList.remove('d-none');
        } else {
            console.error(`View with ID '${viewId}' not found.`);
            return;
        }

        // 3. Update Sidebar Active State
        if (linkElement) {
            document.querySelectorAll('.list-group-item').forEach(el => {
                el.classList.remove('active', 'text-white');
                el.classList.add('text-white-50');
            });
            linkElement.classList.remove('text-white-50');
            linkElement.classList.add('active', 'text-white');
        }

        // 4. Trigger specific renders if needed
        if (viewId === 'view-households') renderHouseholdsDirectory();
        if (viewId === 'view-projects') renderProjectsDirectory();
        if (viewId === 'view-donations') renderDonationsTable();
        if (viewId === 'view-dashboard') renderDashboard();
    }

    // Drill-down from Dashboard
    window.goToDonationsFiltered = function (overrides = {}) {
        // 1. Get Dashboard state
        const startYear = document.getElementById('filter-year-start').value;
        const endYear = document.getElementById('filter-year-end').value;
        const project = document.getElementById('filter-project').value;
        const method = document.getElementById('filter-method').value;

        // 2. Set Donation Filters (sync with dashboard, apply overrides)
        const dStart = document.getElementById('dm-filter-year-start');
        const dEnd = document.getElementById('dm-filter-year-end');
        const dHouse = document.getElementById('dm-filter-household');
        const dMethod = document.getElementById('dm-filter-method');

        if (dStart) dStart.value = startYear;
        if (dEnd) dEnd.value = endYear;
        // Project filter doesn't exist in Donations view currently, but we filter loosely by it? 
        // User didn't ask to add Project filter to donation view, but likely expects functionality.
        // The implementation plan implies applying filters. 
        // Donations view handles Project via columns, but not explicit filter dropdown.
        // Wait, if I click "By Project" chart, I expect to see only that project.
        // Use a hidden or new mechanism? OR just filter in `renderDonationsTable` based on a global or arg?
        // Actually, `renderDonationsTable` reads from DOM elements. 
        // To support project filtering from drill-down without a dropdown, we might need a temporary state or add the dropdown.
        // Let's add a temporary global filter state or valid Project Filter to donations view? 
        // The user didn't explicitly ask for a Project Filter dropdown in Donations view, but did ask for drill down.
        // I will assume for now I should just set the other filters.
        // Update: Implementation plan said "Syncs filters ... Applies overrides".

        // Handle explicit "Method" override
        if (overrides.method) {
            dMethod.value = overrides.method;
        } else if (method !== 'All') {
            dMethod.value = method;
        } else {
            dMethod.value = 'All';
        }

        // Handle Household (default All unless specific context which is not dashboard usually)
        if (dHouse) dHouse.value = 'All';

        // 3. Switch View
        // Find the donations link in sidebar
        const donationsLink = document.querySelector('a[onclick*="view-donations"]');
        switchView('view-donations', donationsLink);

        // 4. Trigger Render with potential special parameters?
        // If we need to filter by Project (which has no dropdown in Donation View), we might fail to show "just that project".
        // Let's rely on what we have. If Project is clicked, we might need to add a Project filter to the Donation View to make it persistent.
        // The user *did* ask for "clicking By Project ... navigate to donations screen filtered by... project".
        // I should probably add a Project filter to Donation View to make this robust. 
        // For now, I'll implement basic sync.

        // Handling Project Drilldown properly requires a target filter.
        // I will inject a Project filter into Donation View in the next step if strictly needed, 
        // but for now let's assume I can add it or just ignore if not present (but user asked for it).
        // Wait, `filteredDonations` in `renderDonationsTable` reads DOM. 
        // I'll add `window.currentProjectFilterOverride` to handle this transiently if I don't add a dropdown?
        // Better: Add the dropdown. It makes sense.

        // For this step, I'll just do the navigation and basic sync.
        // I will add the Project Filter to `renderDonationsTable` logic and Index.html in a moment or now?
        // I'll stick to replacing the logic here first.

        // Special case: Project override
        window.donationProjectFilter = overrides.project || (project !== 'All' ? project : null);

        renderDonationsTable();
    }

    // --- HOUSEHOLD NAME FORMATTING ---
    function formatHouseholdName(members) {
        if (!members || members.length === 0) return "Unknown";

        if (members.length === 1) {
            return `${members[0].first_name} ${members[0].last_name}`;
        }

        // Check if all members share the same last name
        const lastNames = members.map(m => m.last_name);
        const allSameLastName = lastNames.every(ln => ln === lastNames[0]);

        if (allSameLastName) {
            // "John and Jane Smith"
            const firstNames = members.map(m => m.first_name).join(' and ');
            return `${firstNames} ${lastNames[0]}`;
        } else {
            // "John Smith & Jane Doe"
            const fullNames = members.map(m => `${m.first_name} ${m.last_name}`);
            return fullNames.join(' & ');
        }
    }

    // --- HOUSEHOLD MANAGEMENT ---
    // --- HOUSEHOLD MANAGEMENT ---
    function renderHouseholdsDirectory() {
        const grid = document.getElementById('households-grid');
        grid.innerHTML = '';

        // Sort by household name
        const sorted = [...STATE.households].sort((a, b) =>
            (a.household_name || '').localeCompare(b.household_name || '')
        );

        sorted.forEach(h => {
            // --- Statistics Calculations ---
            const hDonations = STATE.donations.filter(d => d.household_id === h.household_id);
            const totalCents = hDonations.reduce((sum, d) => sum + d.amount_cents, 0);
            const totalRaised = totalCents / 100;
            const count = hDonations.length;

            // Last Gift Date
            let lastGiftDate = 'Never';
            if (count > 0) {
                // dates are ISO strings, compatible with Date constructor
                const dates = hDonations.map(d => new Date(d.date).getTime());
                const maxDate = new Date(Math.max(...dates));
                lastGiftDate = maxDate.toLocaleDateString();
            }

            // Format Currency
            const formattedTotal = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalRaised);


            const address = h.address ?
                `${h.address.street || ''}${h.address.street2 ? ', ' + h.address.street2 : ''}, ${h.address.city || ''}, ${h.address.state || ''} ${h.address.zip || ''}`.replace(/^[,\s]+|[,\s]+$/g, '')
                : 'No Address';

            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            // Generate Member List HTML
            const membersHtml = h.members.map(m => {
                const parts = [];
                // Add stopPropagation to mail link to prevent card click
                if (m.email) parts.push(`<a href="mailto:${m.email}" class="text-decoration-none text-muted" onclick="event.stopPropagation()"><i class="bi bi-envelope"></i> ${m.email}</a>`);
                if (m.phone) parts.push(`<span class="text-muted"><i class="bi bi-telephone"></i> ${m.phone}</span>`);
                const contactInfo = parts.join(' &bull; ');

                return `
                    <div class="mb-2 pb-2 border-bottom last-child-no-border">
                        <strong>${m.first_name} ${m.last_name}</strong>
                        ${contactInfo ? `<div class="small">${contactInfo}</div>` : ''}
                    </div>
                `;
            }).join('');

            col.innerHTML = `
                <div class="card h-100 shadow-sm" style="cursor: pointer;" onclick="editHousehold('${h.household_id}')">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-truncate" title="${h.household_name}">${h.household_name}</h5>
                        <!-- Dropdown Menu -->
                        <div class="dropdown">
                            <!-- stopPropagation on button is crucial -->
                            <button class="btn btn-sm btn-link text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation()">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="editHousehold('${h.household_id}')"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="viewHouseholdDonations('${h.household_id}')"><i class="bi bi-wallet2 me-2"></i>History</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteHousehold('${h.household_id}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                         <!-- Statistics Row -->
                         <div class="row mb-3 text-center border-bottom pb-2">
                            <div class="col-4 border-end">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Lifetime</span>
                                <span class="fw-bold text-success">${formattedTotal}</span>
                            </div>
                            <div class="col-4 border-end">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Gifts</span>
                                <span class="fw-bold">${count}</span>
                            </div>
                             <div class="col-4">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Last</span>
                                <span class="fw-bold small">${lastGiftDate}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            ${membersHtml}
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-geo-alt me-1"></i> ${address}
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(col);
        });
    }

    function viewHouseholdDonations(id) {
        // Find the donations nav link to update active state
        // The onclick in sidebar is: onclick="switchView('view-donations', this)"
        const donationsLink = document.querySelector('a[onclick*="view-donations"]');

        switchView('view-donations', donationsLink);

        // Update Filter
        const hhSelect = document.getElementById('dm-filter-household');
        if (hhSelect) {
            hhSelect.value = id;
            // If the ID isn't in the list (shouldn't happen if data syncs), fallback
            if (hhSelect.value !== id) hhSelect.value = 'All';
        }

        // Render
        renderDonationsTable();
    }

    // Dynamic member input management
    let memberCount = 1;

    // --- PHONE FORMATTING ---
    function formatPhoneNumber(value) {
        if (!value) return value;
        const current = value.replace(/[^\d]/g, '');
        const mobileReg = /(^[0-9]{3})([0-9]{3})([0-9]{4}$)/;
        if (current.length >= 10) {
            return current.replace(mobileReg, '($1) $2-$3').slice(0, 14); // Limit length
        }
        return value;
    }

    function setupPhoneFormatter(input) {
        input.addEventListener('input', function (e) {
            const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
    }

    function setupEmailValidation(input) {
        input.addEventListener('blur', function (e) {
            const email = e.target.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email && !emailRegex.test(email)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });

        // Remove invalid state as soon as user types again
        input.addEventListener('input', function (e) {
            e.target.classList.remove('is-invalid');
        });
    }

    // --- AUTO-GENERATION LOGIC ---
    let isHouseholdNameManuallyEdited = false;

    function setupHouseholdAutoNaming() {
        const nameInput = document.getElementById('h-name');

        // Track manual edits
        nameInput.addEventListener('input', () => {
            if (nameInput.value.trim() !== '') {
                isHouseholdNameManuallyEdited = true;
            }
        });


        // Attach to initial Member 1
        attachNameListeners(1);
        setupPhoneFormatter(document.getElementById('m1-phone'));
        setupEmailValidation(document.getElementById('m1-email'));

    }

    function openAddHouseholdModal() {
        resetAddHouseholdModal();
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function attachNameListeners(id) {
        const first = document.getElementById(`m${id}-first`);
        const last = document.getElementById(`m${id}-last`);

        if (first) first.addEventListener('input', updateHouseholdNameAuto);
        if (last) last.addEventListener('input', updateHouseholdNameAuto);
    }

    function updateHouseholdNameAuto() {
        if (isHouseholdNameManuallyEdited) return;

        const members = [];
        // Scan all potential members up to memberCount
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            const lastInput = document.getElementById(`m${i}-last`);

            // Only include if input elements exist and have at least one name part
            if (firstInput && lastInput) {
                const first = firstInput.value.trim();
                const last = lastInput.value.trim();

                if (first || last) {
                    members.push({ first_name: first, last_name: last });
                }
            }
        }

        const nameInput = document.getElementById('h-name');
        if (members.length > 0) {
            nameInput.value = formatHouseholdName(members);
        } else {
            nameInput.value = '';
        }
    }

    function addMemberInput() {
        memberCount++;
        const container = document.getElementById('members-container');
        const memberDiv = document.createElement('div');
        memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
        memberDiv.id = `member-${memberCount}`;

        memberDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Member ${memberCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">
                    Remove
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-first" placeholder="First Name" required>
                    <input type="hidden" id="m${memberCount}-id">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-last" placeholder="Last Name" required>
                </div>
                <div class="col-md-6">
                    <input type="email" class="form-control" id="m${memberCount}-email" placeholder="Email (optional)">
                </div>
                <div class="col-md-6">
                    <input type="tel" class="form-control" id="m${memberCount}-phone" placeholder="Phone (optional)">
                </div>
            </div>
        `;

        container.appendChild(memberDiv);

        // Attach listeners to new inputs
        attachNameListeners(memberCount);
        setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
        setupEmailValidation(document.getElementById(`m${memberCount}-email`));
    }

    function removeMemberInput(id) {
        const element = document.getElementById(`member-${id}`);
        if (element) {
            element.remove();
            // Re-calculate name after removal
            updateHouseholdNameAuto();
        }
    }

    function resetAddHouseholdModal() {
        // Reset Form
        document.getElementById('add-household-form').reset();
        document.getElementById('household-id').value = ''; // Clear ID
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Add New Household';
        isHouseholdNameManuallyEdited = false; // Reset auto-naming flag

        // Reset members container to single member
        document.getElementById('members-container').innerHTML = `
            <div class="member-input-group p-3 mb-3 border rounded bg-light" id="member-1">
                <h6 class="mb-2">Member 1</h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-first" placeholder="First Name" required>
                         <input type="hidden" id="m1-id">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-last" placeholder="Last Name" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m1-email" placeholder="Email (optional)">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m1-phone" placeholder="Phone (optional)">
                    </div>
                </div>
            </div>
        `;
        memberCount = 1;
        attachNameListeners(1); // Re-attach listeners to new inputs
        setupPhoneFormatter(document.getElementById('m1-phone')); // Re-attach formatting
        setupEmailValidation(document.getElementById('m1-email')); // Re-attach validation
    }

    function editHousehold(id) {
        const household = STATE.households.find(h => h.household_id === id);
        if (!household) return;

        // Reset modal to clean state
        resetAddHouseholdModal();

        // 1. Set Household ID and basic info
        document.getElementById('household-id').value = household.household_id;
        document.getElementById('h-name').value = household.household_name;
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Edit Household';

        // Check if existing name matches the auto-generated pattern
        const autoName = formatHouseholdName(household.members);
        if (household.household_name === autoName) {
            isHouseholdNameManuallyEdited = false;
        } else {
            isHouseholdNameManuallyEdited = true;
        }

        // 2. Set Address
        if (household.address) {
            document.getElementById('h-street').value = household.address.street || '';
            document.getElementById('h-street2').value = household.address.street2 || '';
            document.getElementById('h-city').value = household.address.city || '';
            document.getElementById('h-state').value = household.address.state || '';
            document.getElementById('h-zip').value = household.address.zip || '';
        }

        // 3. Set Members
        const container = document.getElementById('members-container');
        container.innerHTML = '';
        memberCount = 0;

        household.members.forEach((m, index) => {
            memberCount++;
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
            memberDiv.id = `member-${memberCount}`;

            // For first member, don't show remove button? Or allowed if multiple?
            // Let's allow removing any member in edit mode, but validation requires at least 1.
            const removeBtn = `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">Remove</button>`;

            memberDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Member ${memberCount}</h6>
                    ${removeBtn}
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-first" value="${m.first_name}" required>
                         <input type="hidden" id="m${memberCount}-id" value="${m.member_id}">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-last" value="${m.last_name}" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m${memberCount}-email" value="${m.email || ''}">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m${memberCount}-phone" value="${m.phone || ''}">
                    </div>
                </div>
            `;
            container.appendChild(memberDiv);

            // Attach listeners
            attachNameListeners(memberCount);
            setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
            setupEmailValidation(document.getElementById(`m${memberCount}-email`));
        });

        // Open Modal
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function deleteHousehold(id) {
        if (!confirm('Are you sure you want to delete this household? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.households = STATE.households.filter(h => h.household_id !== id);
                renderHouseholdsDirectory();
                initAutocomplete(); // Refresh search index
                renderFilters(); // Added to refresh household filters
                showAlert('success', 'Household deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error deleting household: ' + err.message);
            })
            .deleteHousehold(id);
    }

    // --- PROJECT MANAGEMENT ---

    function renderProjectsDirectory() {
        const grid = document.getElementById('projects-grid');
        grid.innerHTML = '';

        // Sort by name
        const sorted = [...STATE.projects].sort((a, b) =>
            (a.name || '').localeCompare(b.name || '')
        );

        sorted.forEach(p => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            col.innerHTML = `
                <div class="card h-100 shadow-sm border-0 border-start border-4 border-primary">
                    <div class="card-body">
                         <div class="d-flex justify-content-between align-items-start mb-2">
                             <h5 class="card-title fw-bold text-primary mb-0">${p.name}</h5>
                             <div class="dropdown">
                                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="editProject('${p.project_id}')"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteProject('${p.project_id}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                         </div>
                         <p class="card-text text-muted">${p.description || '<span class="fst-italic">No description</span>'}</p>
                    </div>
                </div>
             `;
            grid.appendChild(col);
        });
    }

    function openAddProjectModal() {
        document.getElementById('add-project-form').reset();
        document.getElementById('project-id').value = '';
        document.querySelector('#addProjectModal .modal-title').textContent = 'Add New Project';
        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    function editProject(id) {
        const project = STATE.projects.find(p => p.project_id === id);
        if (!project) return;

        document.getElementById('project-id').value = project.project_id;
        document.getElementById('p-name').value = project.name;
        document.getElementById('p-desc').value = project.description || '';
        document.querySelector('#addProjectModal .modal-title').textContent = 'Edit Project';

        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    function submitProject() {
        const btn = document.getElementById('btn-save-project');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const project_id = document.getElementById('project-id').value;
        const name = document.getElementById('p-name').value;
        const description = document.getElementById('p-desc').value;

        if (!name) {
            alert("Project Name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { project_id, name, description };

        const handler = (res) => {
            // Handle Success
            if (project_id) {
                // Update Existing
                const idx = STATE.projects.findIndex(p => p.project_id === project_id);
                if (idx !== -1) STATE.projects[idx] = { project_id, name, description };
            } else {
                // Add New
                STATE.projects.push({ project_id: res.project_id, name: res.name, description });
            }

            // Refresh UI and Dropdown
            renderProjectsDirectory();
            refreshProjectDropdown();
            renderFilters(); // Added to refresh dashboard project filter // We need to create this helper or inline it

            // Close Modal
            const modalEl = document.getElementById('addProjectModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            document.getElementById('add-project-form').reset();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', project_id ? 'Project updated successfully!' : 'Project added successfully!');
        };

        if (project_id) {
            google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }).updateProject(payload);
        } else {
            google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }).saveProject(payload);
        }
    }

    function deleteProject(id) {
        if (!confirm('Are you sure you want to delete this project?')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.projects = STATE.projects.filter(p => p.project_id !== id);
                renderProjectsDirectory();
                refreshProjectDropdown();
                renderFilters(); // Added to refresh dashboard project filter
                showAlert('success', 'Project deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error: ' + err.message);
            })
            .deleteProject(id);
    }
    function refreshProjectDropdown() {
        const projectSelect = document.getElementById('project');
        projectSelect.innerHTML = '<option value="">No Project</option>';
        STATE.projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.project_id;
            option.textContent = p.name;
            projectSelect.appendChild(option);
        });
    }

    // --- ANALYTICS DASHBOARD ---

    function resetDashboardFilters() {
        document.getElementById('filter-year').value = 'All';
        document.getElementById('filter-project').value = 'All';
        document.getElementById('filter-method').value = 'All';
        document.getElementById('filter-amount').value = 0;
        document.getElementById('slider-val-display').textContent = '$0';
        renderDashboard();
    }

    function renderDashboard() {
        // 1. Get Filter Values
        const startYear = parseInt(document.getElementById('filter-year-start').value);
        const endYear = parseInt(document.getElementById('filter-year-end').value);
        const fProject = document.getElementById('filter-project').value;
        const fMethod = document.getElementById('filter-method').value;
        const fAmount = parseInt(document.getElementById('filter-amount').value);

        // 2. Filter Data
        const filtered = STATE.donations.filter(d => {
            const dYear = new Date(d.date).getFullYear();
            if (dYear < startYear || dYear > endYear) return false;

            if (fProject !== 'All' && d.project_id !== fProject) return false;
            if (fMethod !== 'All' && d.method !== fMethod) return false;
            if (d.amount_cents / 100 < fAmount) return false;
            return true;
        });

        // 3. Compute KPIs
        const totalCents = filtered.reduce((sum, d) => sum + d.amount_cents, 0);
        const totalRaised = totalCents / 100;
        const count = filtered.length;
        const avg = count ? (totalRaised / count) : 0;
        const uniqueDonors = new Set(filtered.map(d => d.household_id)).size;

        // 4. Update KPI Counters with Animation
        animateValue("kpi-total", totalRaised, "$");
        animateValue("kpi-count", count, "");
        animateValue("kpi-avg", avg, "$");
        animateValue("kpi-donors", uniqueDonors, "");

        // 5. Render Charts
        renderCharts(filtered);
    }

    function animateValue(id, value, prefix = "") {
        const obj = document.getElementById(id);
        const start = 0;
        const end = value;
        const duration = 800;
        let startTimestamp = null;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);

            // Format number
            const current = progress * (end - start) + start;
            let formatted;
            if (prefix === "$") {
                formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(current);
            } else {
                formatted = Math.floor(current);
            }

            obj.innerHTML = formatted;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function renderCharts(data) {
        // Prepare Data
        if (data.length === 0) return; // Handle empty

        // 1. Timeline (Monthly? Yearly?)
        const timelineData = {};
        data.forEach(d => {
            const y = new Date(d.date).getFullYear();
            timelineData[y] = (timelineData[y] || 0) + d.amount_cents / 100;
        });

        // 2. By Project
        const projectData = {};
        data.forEach(d => {
            const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'Unknown';
            projectData[pName] = (projectData[pName] || 0) + d.amount_cents / 100;
            // Store ID for lookup on click
            if (!projectData[pName + '_id']) projectData[pName + '_id'] = d.project_id;
        });

        // 3. Methods
        const methodData = {};
        data.forEach(d => {
            methodData[d.method] = (methodData[d.method] || 0) + d.amount_cents / 100;
        });

        // --- RENDER ---

        // Timeline
        renderChart('chart-timeline', 'bar', Object.keys(timelineData), Object.values(timelineData), 'Total Raised ($)');

        // Project
        // Custom render to attach IDs relative to labels?
        // ChartJS onClick gives index. We can map back to keys.
        const projLabels = Object.keys(projectData).filter(k => !k.endsWith('_id'));
        const projValues = projLabels.map(k => projectData[k]);

        renderChart('chart-project', 'doughnut', projLabels, projValues, 'By Project', {
            onClick: (evt, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = projLabels[index];
                    const pid = projectData[label + '_id'];
                    goToDonationsFiltered({ project: pid });
                }
            }
        });

        // Method
        const methodLabels = Object.keys(methodData);
        const methodValues = Object.values(methodData);
        renderChart('chart-method', 'pie', methodLabels, methodValues, 'Payment Methods', {
            onClick: (evt, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const label = methodLabels[index];
                    goToDonationsFiltered({ method: label });
                }
            }
        });
    }

    function renderChart(canvasId, type, labels, data, label, options = {}) {
        const ctx = document.getElementById(canvasId).getContext('2d');

        if (CHARTS[canvasId]) {
            CHARTS[canvasId].destroy();
        }

        CHARTS[canvasId] = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                preserveAspectRatio: false,
                ...options
            }
        });
    }

    function submitHousehold() {
        const btn = document.getElementById('btn-save-household');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        // Collect household info
        const household_id = document.getElementById('household-id').value;
        const household_name = document.getElementById('h-name').value;
        const address = {
            street: document.getElementById('h-street').value,
            street2: document.getElementById('h-street2').value,
            city: document.getElementById('h-city').value,
            state: document.getElementById('h-state').value,
            zip: document.getElementById('h-zip').value
        };

        // Collect all members
        const members = [];
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            if (!firstInput) continue; // Skipped if removed

            const first_name = firstInput.value;
            const last_name = document.getElementById(`m${i}-last`).value;
            const email = document.getElementById(`m${i}-email`).value;
            const phone = document.getElementById(`m${i}-phone`).value;
            const member_id = document.getElementById(`m${i}-id`).value; // Get ID if editing

            if (!first_name || !last_name) {
                alert(`Member ${i}: First and Last Name are required.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Email validation (check if visual validation failed)
            const emailInput = document.getElementById(`m${i}-email`);
            if (emailInput.classList.contains('is-invalid')) {
                alert(`Member ${i}: Please fix the invalid email address.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Double check in case they submitted without blurring
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                alert(`Member ${i}: Please enter a valid email address.`);
                emailInput.classList.add('is-invalid');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            members.push({ member_id, first_name, last_name, email, phone });
        }

        if (members.length === 0) {
            alert("At least one household member is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        if (!household_name) {
            alert("Household name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { household_id, household_name, address, members };

        const handler = (res) => {
            // Handle Success (Create or Update)
            const existingIdx = STATE.households.findIndex(h => h.household_id === res.household_id);
            const newHousehold = {
                household_id: res.household_id,
                household_name: payload.household_name,
                address: address,
                members: members
                // Note: Newly created members won't have IDs here until refresh, 
                // but that's okay for UI display. Full refresh on page load fixes it.
                // Ideally we'd return full object from server.
            };

            if (existingIdx !== -1) {
                STATE.households[existingIdx] = newHousehold;
            } else {
                STATE.households.push(newHousehold);
            }

            // Refresh UI
            renderHouseholdsDirectory();
            initAutocomplete(); // Update search index
            renderFilters(); // Added to refresh household filters

            // Close Modal
            const modalEl = document.getElementById('addHouseholdModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Reset Form
            resetAddHouseholdModal();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', household_id ? 'Household updated successfully!' : 'Household added successfully!');
        };

        if (household_id) {
            // Update
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .updateHousehold(payload);
        } else {
            // Create
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .saveHousehold(payload);
        }
    }


    // --- DONATION FORM ---
    function initAutocomplete() {
        const input = document.getElementById('household-search');
        const resultsList = document.getElementById('results-list');
        const hiddenId = document.getElementById('selected-household-id');
        const membersDisplay = document.getElementById('selected-household-members');

        input.addEventListener('keyup', (e) => {
            const query = e.target.value.toLowerCase();
            resultsList.innerHTML = '';
            resultsList.classList.add('d-none');
            membersDisplay.innerHTML = '';

            if (query.length < 2) return;

            const matches = STATE.households.filter(h =>
                (h.search_index || '').toLowerCase().includes(query)
            ).slice(0, 5);

            if (matches.length > 0) {
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action cursor-pointer';
                    li.innerHTML = `
                        <strong>${match.household_name}</strong><br>
                        <small class="text-muted">${formatHouseholdName(match.members)}</small>
                    `;

                    li.onclick = () => {
                        input.value = match.household_name;
                        hiddenId.value = match.household_id;
                        resultsList.classList.add('d-none');
                        input.classList.add('is-valid');

                        // Display member info
                        const memberInfo = match.members.map(m =>
                            `${m.first_name} ${m.last_name}${m.email ? ` (${m.email})` : ''}`
                        ).join('<br>');
                        membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
                    };

                    resultsList.appendChild(li);
                });
                resultsList.classList.remove('d-none');
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== input && e.target !== resultsList) {
                resultsList.classList.add('d-none');
            }
        });
    }

    function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    }

    function showError(err) {
        console.error(err);
        showAlert('danger', 'System Error: ' + err.message);
    }
    // --- DONATION MANAGEMENT ---

    function resetDonationFilters() {
        document.getElementById('dm-filter-year-end').value = new Date().getFullYear();
        // Reset start year to min available? Or just match end? 
        // Let's defer to renderFilters logic or just set to first option?
        // Actually renderFilters set sensible defaults. Let's just re-call renderFilters or manually set.
        // Easiest is to reload page? No.
        // Let's start with "All Time" equivalent? The range selector forces a range.
        // Set Start to Min, End to Max.
        const startSel = document.getElementById('dm-filter-year-start');
        const endSel = document.getElementById('dm-filter-year-end');
        if (startSel.options.length > 0) startSel.selectedIndex = 0;
        if (endSel.options.length > 0) endSel.selectedIndex = endSel.options.length - 1;

        document.getElementById('dm-filter-household').value = 'All';
        document.getElementById('dm-filter-method').value = 'All';
        window.donationProjectFilter = null; // Clear override
        renderDonationsTable();
    }

    function renderDonationsTable() {
        // 1. Get Filters
        const startYear = parseInt(document.getElementById('dm-filter-year-start').value);
        const endYear = parseInt(document.getElementById('dm-filter-year-end').value);
        const householdId = document.getElementById('dm-filter-household').value;
        const method = document.getElementById('dm-filter-method').value;

        // 2. Filter Data
        let filtered = STATE.donations.filter(d => {
            const dYear = new Date(d.date).getFullYear();
            if (dYear < startYear || dYear > endYear) return false;

            if (householdId !== 'All' && d.household_id !== householdId) return false;
            if (method !== 'All' && d.method !== method) return false;

            // Check for transient Project override (from drill-down)
            if (window.donationProjectFilter && d.project_id !== window.donationProjectFilter) return false;

            return true;
        });

        // Clear transient filter after use? 
        // If we clear it, re-rendering (e.g. changing year) will lose the project filter.
        // So we should NOT clear it unless the user explicitly resets or navigates away.
        // Ideally we'd show UI for it, but for now invisible persistence is acceptable for this Drill-down feature.

        // 3. Render Global Summary
        const summaryContainer = document.getElementById('donations-summary');
        if (summaryContainer) {
            const totalCents = filtered.reduce((sum, d) => sum + d.amount_cents, 0);
            const totalCount = filtered.length;

            // Breakdowns
            const byProject = {};
            const byMethod = {};

            filtered.forEach(d => {
                const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'Unknown';
                if (!byProject[pName]) byProject[pName] = { count: 0, cents: 0 };
                byProject[pName].count++;
                byProject[pName].cents += d.amount_cents;

                if (!byMethod[d.method]) byMethod[d.method] = { count: 0, cents: 0 };
                byMethod[d.method].count++;
                byMethod[d.method].cents += d.amount_cents;
            });

            // Generate Summary HTML
            const formatMoney = (cents) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(cents / 100);

            let projectSummaryHtml = Object.entries(byProject).map(([name, stats]) =>
                `<div><small class="text-muted">${name}:</small> <strong>${formatMoney(stats.cents)}</strong> <span class="text-muted">(${stats.count})</span></div>`
            ).join('');

            let methodSummaryHtml = Object.entries(byMethod).map(([name, stats]) =>
                `<div class="me-3"><small class="text-muted">${name}:</small> <strong>${formatMoney(stats.cents)}</strong> <span class="text-muted">(${stats.count})</span></div>`
            ).join('');

            summaryContainer.innerHTML = `
                <div class="card bg-light border-0">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="me-4 border-end pe-4">
                                <span class="text-muted small text-uppercase">Total</span>
                                <div class="fs-4 fw-bold text-success">${formatMoney(totalCents)}</div>
                                <div class="small text-muted">${totalCount} donations</div>
                            </div>
                            <div class="flex-grow-1 border-end px-4">
                                <span class="text-muted small text-uppercase d-block mb-1">By Project</span>
                                <div class="d-flex flex-wrap gap-3">${projectSummaryHtml || '<span class="text-muted small">-</span>'}</div>
                            </div>
                            <div class="ps-4">
                                <span class="text-muted small text-uppercase d-block mb-1">By Method</span>
                                <div class="d-flex flex-wrap">${methodSummaryHtml || '<span class="text-muted small">-</span>'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 4. Group by Household
        const grouped = {}; // household_id -> { household: obj, donations: [] }

        filtered.forEach(d => {
            if (!grouped[d.household_id]) {
                grouped[d.household_id] = {
                    household: STATE.households.find(h => h.household_id === d.household_id) || { household_name: 'Unknown Group' },
                    donations: []
                };
            }
            grouped[d.household_id].donations.push(d);
        });

        // 5. Render Table Rows
        const tbody = document.getElementById('donations-table-body');
        tbody.innerHTML = '';
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No donations found matching criteria.</td></tr>';
            return;
        }

        // Sort Groups by Household Name
        const sortedGroups = Object.values(grouped).sort((a, b) =>
            (a.household.household_name || '').localeCompare(b.household.household_name || '')
        );

        sortedGroups.forEach(group => {
            const hId = group.household.household_id || 'unknown';
            const donations = group.donations.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

            const groupTotalCents = donations.reduce((sum, d) => sum + d.amount_cents, 0);
            const groupCount = donations.length;
            const formatMoney = (cents) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(cents / 100);

            // Group Header Row
            const headerRow = document.createElement('tr');
            headerRow.className = 'table-secondary';
            headerRow.style.cursor = 'pointer';
            headerRow.onclick = () => toggleGroup(hId);
            headerRow.innerHTML = `
                <td colspan="6">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-chevron-right me-2 transition-transform" id="icon-${hId}"></i>
                            <span class="fw-bold">${group.household.household_name}</span>
                        </div>
                        <div class="d-flex gap-3 text-muted small">
                            <span>Count: <strong>${groupCount}</strong></span>
                            <span>Total: <strong class="text-dark">${formatMoney(groupTotalCents)}</strong></span>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(headerRow);

            // Child Rows Container
            const childRow = document.createElement('tr');
            childRow.id = `group-${hId}`;
            childRow.className = 'd-none'; // Hidden by default

            const gByProject = {};
            donations.forEach(d => {
                const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'Unknown';
                gByProject[pName] = (gByProject[pName] || 0) + d.amount_cents;
            });
            const gProjectSummary = Object.entries(gByProject).map(([name, cents]) =>
                `<span class="badge bg-light text-dark border me-1">${name}: ${formatMoney(cents)}</span>`
            ).join('');

            const childContent = `
                <td colspan="6" class="p-0 border-0">
                   <div class="p-3 bg-white border-bottom">
                        ${gProjectSummary ? `<div class="mb-2 small">${gProjectSummary}</div>` : ''}
                        
                        <table class="table table-sm table-borderless mb-0">
                            <tbody>
                                ${donations.map(d => {
                const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'No Project';
                return `
                                        <tr class="donation-row border-bottom" onclick="openDonationModal('${d.txn_id}')" style="cursor: pointer;">
                                            <td style="width: 15%;" class="ps-4 text-muted">${d.date.substring(0, 10)}</td>
                                            <td style="width: 25%;"></td> <!-- Empty Household Col -->
                                            <td style="width: 15%;" class="fw-bold">${formatMoney(d.amount_cents)}</td>
                                            <td style="width: 20%;">${pName}</td>
                                            <td style="width: 15%;">${d.method}</td>
                                            <td style="width: 10%; text-end"><i class="bi bi-pencil-square text-muted opacity-25"></i></td> 
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                   </div>
                </td>
            `;
            childRow.innerHTML = childContent;
            tbody.appendChild(childRow);

            // Auto-expand if filtered by specific household
            if (householdId !== 'All') {
                toggleGroup(hId);
            }
        });
    }

    function toggleGroup(hId) {
        const row = document.getElementById(`group-${hId}`);
        const icon = document.getElementById(`icon-${hId}`);
        if (row.classList.contains('d-none')) {
            row.classList.remove('d-none');
            icon.classList.remove('bi-chevron-right');
            icon.classList.add('bi-chevron-down');
        } else {
            row.classList.add('d-none');
            icon.classList.remove('bi-chevron-down');
            icon.classList.add('bi-chevron-right');
        }
    }

    function renderHouseholdMembersPreview(members) {
        if (!members || members.length === 0) return;
        const membersDisplay = document.getElementById('selected-household-members');
        const memberInfo = members.map(m =>
            `${m.first_name} ${m.last_name}${m.email ? ` (${m.email})` : ''}`
        ).join('<br>');
        membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
    }

    let donationModal = null; // Store Bootstrap Modal instance

    function openDonationModal(txn_id = null) {
        if (!donationModal) {
            donationModal = new bootstrap.Modal(document.getElementById('donationModal'));
        }

        const form = document.getElementById('donation-form');
        // Reset Validations
        document.getElementById('household-search').classList.remove('is-valid');
        document.getElementById('selected-household-members').innerHTML = '';

        if (txn_id) {
            // EDIT MODE
            const donation = STATE.donations.find(d => d.txn_id === txn_id);
            if (!donation) return;

            document.getElementById('donationModalLabel').innerText = 'Edit Donation';
            document.getElementById('donation-txn-id').value = donation.txn_id;

            // Pre-fill fields
            const household = STATE.households.find(h => h.household_id === donation.household_id);
            document.getElementById('household-search').value = household ? household.household_name : '';
            document.getElementById('selected-household-id').value = donation.household_id;
            document.getElementById('amount').value = donation.amount_cents / 100;

            // Format date for input type="date" (YYYY-MM-DD)
            const d = new Date(donation.date);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

            document.getElementById('project').value = donation.project_id || '';
            document.getElementById('method').value = donation.method;

            // Show members preview
            if (household) {
                renderHouseholdMembersPreview(household.members);
            }

        } else {
            // ADD MODE
            document.getElementById('donationModalLabel').innerText = 'Log New Donation';
            document.getElementById('donation-txn-id').value = ''; // Empty for new
            form.reset();
            document.getElementById('selected-household-id').value = '';
            document.getElementById('date').valueAsDate = new Date();
        }

        donationModal.show();
    }

    function submitDonation() {
        const btn = document.getElementById('submit-donation-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const txnId = document.getElementById('donation-txn-id').value;
        const householdId = document.getElementById('selected-household-id').value;
        const project = document.getElementById('project').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        const method = document.getElementById('method').value;

        if (!householdId) {
            alert('Please select a household from the search list.');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = {
            txn_id: txnId, // Will be empty if new
            household_id: householdId,
            project_id: project,
            amount_cents: Math.round(amount * 100),
            date: date,
            method: method
        };

        const successHandler = (res) => {
            btn.disabled = false;
            btn.textContent = originalText;

            // Close Modal
            if (donationModal) donationModal.hide();

            // Update Local State
            if (txnId) { // Update
                const idx = STATE.donations.findIndex(d => d.txn_id === txnId);
                if (idx !== -1) STATE.donations[idx] = payload;
            } else { // Create
                payload.txn_id = res.txn_id;
                STATE.donations.push(payload);
            }

            // Refresh Views
            renderDonationsTable();
            renderDashboard();
            renderFilters(); // Added to refresh year/household filters
            showAlert('success', txnId ? 'Donation updated!' : 'Donation logged successfully!');
        };

        const failureHandler = (err) => {
            btn.disabled = false;
            btn.textContent = originalText;
            alert('Error: ' + err.message);
        };

        if (txnId) {
            google.script.run
                .withSuccessHandler(successHandler)
                .withFailureHandler(failureHandler)
                .updateDonation(payload);
        } else {
            google.script.run
                .withSuccessHandler(successHandler)
                .withFailureHandler(failureHandler)
                .saveDonation(payload);
        }
    }

    function deleteDonation(txn_id) {
        if (!confirm('Are you sure you want to delete this donation? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                // Update State
                STATE.donations = STATE.donations.filter(d => d.txn_id !== txn_id);
                // Refresh Views
                renderDonationsTable();
                renderDashboard();
                renderFilters(); // Added to refresh filters
                showAlert('success', 'Donation deleted.');
            })
            .withFailureHandler((err) => {
                alert('Error deleting donation: ' + err.message);
            })
            .deleteDonation(txn_id);
    }
</script>