<script>
    let STATE = { households: [], projects: [], donations: [] };
    let CHARTS = {}; // Store chart instances

    window.onload = function () {
        document.getElementById('date').valueAsDate = new Date();
        google.script.run
            .withSuccessHandler(initApp)
            .withFailureHandler(showError)
            .getInitialData();
    };

    function initApp(resp) {
        console.log('initApp started with response:', resp);
        try {
            if (!resp) throw new Error("No response received from backend");
            if (resp.status === 'error') throw new Error("Server Error: " + resp.message);
            if (!resp.data) throw new Error("Response is missing data payload");

            const data = resp.data;

            STATE.households = data.households || [];
            STATE.projects = data.projects || [];
            STATE.donations = data.donations || [];

            renderFilters();

            // Populate Projects Dropdown (Modal)
            // ... (rest of function)

            const projectSelect = document.getElementById('project');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">No Project</option>';
                STATE.projects.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.project_id;
                    option.textContent = p.name;
                    projectSelect.appendChild(option);
                });
            } else {
                console.warn('Project dropdown not found');
            }

            initAutocomplete();
            renderHouseholdsDirectory();
            renderProjectsDirectory();
            try { renderDashboard(); } catch (e) { console.warn('Dashboard render failed', e); }
            try { renderDonationsTable(); } catch (e) { console.warn('Donations table render failed', e); }

            // Initialize auto-naming
            setupHouseholdAutoNaming();

        } catch (error) {
            console.error('CRITICAL INIT ERROR:', error);
            showError(error);
        }
    }

    function renderFilters() {
        // Initialize Filter Years (Dashboard & Donation Management)
        const yearSelect = document.getElementById('filter-year');
        const dmYearSelect = document.getElementById('dm-filter-year'); // Fix: was using getElementById but variable name implies existence

        // Save current selection to restore if possible
        const currentYear = yearSelect ? yearSelect.value : 'All';
        const currentDmYear = dmYearSelect ? dmYearSelect.value : 'All';

        if (yearSelect) yearSelect.innerHTML = '<option value="All">All Time</option>';
        if (dmYearSelect) dmYearSelect.innerHTML = '<option value="All">All Years</option>';

        const years = [...new Set(STATE.donations.map(d => new Date(d.date).getFullYear()))].sort().reverse();

        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.innerText = y;
            // if (yearSelect) yearSelect.appendChild(opt); // Duplicate logic, better to clone?
            if (yearSelect) yearSelect.appendChild(opt.cloneNode(true));

            if (dmYearSelect) {
                const dmOpt = document.createElement('option');
                dmOpt.value = y;
                dmOpt.innerText = y;
                dmYearSelect.appendChild(dmOpt);
            }
        });

        // Restore selection
        if (yearSelect) yearSelect.value = currentYear;
        // if restored value is not in list (e.g. year deleted?), it falls back to first option (All) automatically? 
        // HTML select behavior: if value not found, it might pick the first one.
        // We verify:
        if (yearSelect && yearSelect.value !== currentYear) yearSelect.value = 'All';


        if (dmYearSelect) dmYearSelect.value = currentDmYear;
        if (dmYearSelect && dmYearSelect.value !== currentDmYear) dmYearSelect.value = 'All';

        // Populate Filter Projects (Dashboard)
        const filterProject = document.getElementById('filter-project');
        if (filterProject) {
            const currentProj = filterProject.value;
            filterProject.innerHTML = '<option value="All">All Projects</option>';
            STATE.projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.project_id;
                option.textContent = p.name;
                filterProject.appendChild(option);
            });
            filterProject.value = currentProj;
            if (filterProject.value !== currentProj) filterProject.value = 'All';
        }

        // Populate Donation Management Household Filter
        const dmHouseholdSelect = document.getElementById('dm-filter-household');
        if (dmHouseholdSelect) {
            const currentH = dmHouseholdSelect.value;
            dmHouseholdSelect.innerHTML = '<option value="All">All Households</option>';
            const sortedHouseholds = [...STATE.households].sort((a, b) => (a.household_name || '').localeCompare(b.household_name || ''));
            sortedHouseholds.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.household_id;
                opt.textContent = h.household_name;
                dmHouseholdSelect.appendChild(opt);
            });
            dmHouseholdSelect.value = currentH;
            if (dmHouseholdSelect.value !== currentH) dmHouseholdSelect.value = 'All';
        }
    }



    // --- NAVIGATION ---
    // --- NAVIGATION ---
    window.switchView = function (viewId, linkElement) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        // Show target
        document.getElementById(viewId).classList.remove('d-none');

        // Update Sidebar Active State
        if (linkElement) {
            document.querySelectorAll('.list-group-item').forEach(el => {
                el.classList.remove('active', 'text-white');
                el.classList.add('text-white-50');
            });
            linkElement.classList.remove('text-white-50');
            linkElement.classList.add('active', 'text-white');
        }
    }

    // --- HOUSEHOLD NAME FORMATTING ---
    function formatHouseholdName(members) {
        if (!members || members.length === 0) return "Unknown";

        if (members.length === 1) {
            return `${members[0].first_name} ${members[0].last_name}`;
        }

        // Check if all members share the same last name
        const lastNames = members.map(m => m.last_name);
        const allSameLastName = lastNames.every(ln => ln === lastNames[0]);

        if (allSameLastName) {
            // "John and Jane Smith"
            const firstNames = members.map(m => m.first_name).join(' and ');
            return `${firstNames} ${lastNames[0]}`;
        } else {
            // "John Smith & Jane Doe"
            const fullNames = members.map(m => `${m.first_name} ${m.last_name}`);
            return fullNames.join(' & ');
        }
    }

    // --- HOUSEHOLD MANAGEMENT ---
    // --- HOUSEHOLD MANAGEMENT ---
    function renderHouseholdsDirectory() {
        const grid = document.getElementById('households-grid');
        grid.innerHTML = '';

        // Sort by household name
        const sorted = [...STATE.households].sort((a, b) =>
            (a.household_name || '').localeCompare(b.household_name || '')
        );

        sorted.forEach(h => {
            // --- Statistics Calculations ---
            const hDonations = STATE.donations.filter(d => d.household_id === h.household_id);
            const totalCents = hDonations.reduce((sum, d) => sum + d.amount_cents, 0);
            const totalRaised = totalCents / 100;
            const count = hDonations.length;

            // Last Gift Date
            let lastGiftDate = 'Never';
            if (count > 0) {
                // dates are ISO strings, compatible with Date constructor
                const dates = hDonations.map(d => new Date(d.date).getTime());
                const maxDate = new Date(Math.max(...dates));
                lastGiftDate = maxDate.toLocaleDateString();
            }

            // Format Currency
            const formattedTotal = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalRaised);


            const address = h.address ?
                `${h.address.street || ''}${h.address.street2 ? ', ' + h.address.street2 : ''}, ${h.address.city || ''}, ${h.address.state || ''} ${h.address.zip || ''}`.replace(/^[,\s]+|[,\s]+$/g, '')
                : 'No Address';

            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            // Generate Member List HTML
            const membersHtml = h.members.map(m => {
                const parts = [];
                // Add stopPropagation to mail link to prevent card click
                if (m.email) parts.push(`<a href="mailto:${m.email}" class="text-decoration-none text-muted" onclick="event.stopPropagation()"><i class="bi bi-envelope"></i> ${m.email}</a>`);
                if (m.phone) parts.push(`<span class="text-muted"><i class="bi bi-telephone"></i> ${m.phone}</span>`);
                const contactInfo = parts.join(' &bull; ');

                return `
                    <div class="mb-2 pb-2 border-bottom last-child-no-border">
                        <strong>${m.first_name} ${m.last_name}</strong>
                        ${contactInfo ? `<div class="small">${contactInfo}</div>` : ''}
                    </div>
                `;
            }).join('');

            col.innerHTML = `
                <div class="card h-100 shadow-sm" style="cursor: pointer;" onclick="editHousehold('${h.household_id}')">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 text-truncate" title="${h.household_name}">${h.household_name}</h5>
                        <!-- Dropdown Menu -->
                        <div class="dropdown">
                            <!-- stopPropagation on button is crucial -->
                            <button class="btn btn-sm btn-link text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation()">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="editHousehold('${h.household_id}')"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="viewHouseholdDonations('${h.household_id}')"><i class="bi bi-wallet2 me-2"></i>History</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteHousehold('${h.household_id}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                         <!-- Statistics Row -->
                         <div class="row mb-3 text-center border-bottom pb-2">
                            <div class="col-4 border-end">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Lifetime</span>
                                <span class="fw-bold text-success">${formattedTotal}</span>
                            </div>
                            <div class="col-4 border-end">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Gifts</span>
                                <span class="fw-bold">${count}</span>
                            </div>
                             <div class="col-4">
                                <span class="d-block small text-muted text-uppercase" style="font-size: 0.7rem;">Last</span>
                                <span class="fw-bold small">${lastGiftDate}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            ${membersHtml}
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-geo-alt me-1"></i> ${address}
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(col);
        });
    }

    function viewHouseholdDonations(id) {
        // Find the donations nav link to update active state
        // The onclick in sidebar is: onclick="switchView('view-donations', this)"
        const donationsLink = document.querySelector('a[onclick*="view-donations"]');

        switchView('view-donations', donationsLink);

        // Update Filter
        const hhSelect = document.getElementById('dm-filter-household');
        if (hhSelect) {
            hhSelect.value = id;
            // If the ID isn't in the list (shouldn't happen if data syncs), fallback
            if (hhSelect.value !== id) hhSelect.value = 'All';
        }

        // Render
        renderDonationsTable();
    }

    // Dynamic member input management
    let memberCount = 1;

    // --- PHONE FORMATTING ---
    function formatPhoneNumber(value) {
        if (!value) return value;
        const current = value.replace(/[^\d]/g, '');
        const mobileReg = /(^[0-9]{3})([0-9]{3})([0-9]{4}$)/;
        if (current.length >= 10) {
            return current.replace(mobileReg, '($1) $2-$3').slice(0, 14); // Limit length
        }
        return value;
    }

    function setupPhoneFormatter(input) {
        input.addEventListener('input', function (e) {
            const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
    }

    function setupEmailValidation(input) {
        input.addEventListener('blur', function (e) {
            const email = e.target.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email && !emailRegex.test(email)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });

        // Remove invalid state as soon as user types again
        input.addEventListener('input', function (e) {
            e.target.classList.remove('is-invalid');
        });
    }

    // --- AUTO-GENERATION LOGIC ---
    let isHouseholdNameManuallyEdited = false;

    function setupHouseholdAutoNaming() {
        const nameInput = document.getElementById('h-name');

        // Track manual edits
        nameInput.addEventListener('input', () => {
            if (nameInput.value.trim() !== '') {
                isHouseholdNameManuallyEdited = true;
            }
        });


        // Attach to initial Member 1
        attachNameListeners(1);
        setupPhoneFormatter(document.getElementById('m1-phone'));
        setupEmailValidation(document.getElementById('m1-email'));

    }

    function openAddHouseholdModal() {
        resetAddHouseholdModal();
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function attachNameListeners(id) {
        const first = document.getElementById(`m${id}-first`);
        const last = document.getElementById(`m${id}-last`);

        if (first) first.addEventListener('input', updateHouseholdNameAuto);
        if (last) last.addEventListener('input', updateHouseholdNameAuto);
    }

    function updateHouseholdNameAuto() {
        if (isHouseholdNameManuallyEdited) return;

        const members = [];
        // Scan all potential members up to memberCount
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            const lastInput = document.getElementById(`m${i}-last`);

            // Only include if input elements exist and have at least one name part
            if (firstInput && lastInput) {
                const first = firstInput.value.trim();
                const last = lastInput.value.trim();

                if (first || last) {
                    members.push({ first_name: first, last_name: last });
                }
            }
        }

        const nameInput = document.getElementById('h-name');
        if (members.length > 0) {
            nameInput.value = formatHouseholdName(members);
        } else {
            nameInput.value = '';
        }
    }

    function addMemberInput() {
        memberCount++;
        const container = document.getElementById('members-container');
        const memberDiv = document.createElement('div');
        memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
        memberDiv.id = `member-${memberCount}`;

        memberDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Member ${memberCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">
                    Remove
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-first" placeholder="First Name" required>
                    <input type="hidden" id="m${memberCount}-id">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-last" placeholder="Last Name" required>
                </div>
                <div class="col-md-6">
                    <input type="email" class="form-control" id="m${memberCount}-email" placeholder="Email (optional)">
                </div>
                <div class="col-md-6">
                    <input type="tel" class="form-control" id="m${memberCount}-phone" placeholder="Phone (optional)">
                </div>
            </div>
        `;

        container.appendChild(memberDiv);

        // Attach listeners to new inputs
        attachNameListeners(memberCount);
        setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
        setupEmailValidation(document.getElementById(`m${memberCount}-email`));
    }

    function removeMemberInput(id) {
        const element = document.getElementById(`member-${id}`);
        if (element) {
            element.remove();
            // Re-calculate name after removal
            updateHouseholdNameAuto();
        }
    }

    function resetAddHouseholdModal() {
        // Reset Form
        document.getElementById('add-household-form').reset();
        document.getElementById('household-id').value = ''; // Clear ID
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Add New Household';
        isHouseholdNameManuallyEdited = false; // Reset auto-naming flag

        // Reset members container to single member
        document.getElementById('members-container').innerHTML = `
            <div class="member-input-group p-3 mb-3 border rounded bg-light" id="member-1">
                <h6 class="mb-2">Member 1</h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-first" placeholder="First Name" required>
                         <input type="hidden" id="m1-id">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-last" placeholder="Last Name" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m1-email" placeholder="Email (optional)">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m1-phone" placeholder="Phone (optional)">
                    </div>
                </div>
            </div>
        `;
        memberCount = 1;
        attachNameListeners(1); // Re-attach listeners to new inputs
        setupPhoneFormatter(document.getElementById('m1-phone')); // Re-attach formatting
        setupEmailValidation(document.getElementById('m1-email')); // Re-attach validation
    }

    function editHousehold(id) {
        const household = STATE.households.find(h => h.household_id === id);
        if (!household) return;

        // Reset modal to clean state
        resetAddHouseholdModal();

        // 1. Set Household ID and basic info
        document.getElementById('household-id').value = household.household_id;
        document.getElementById('h-name').value = household.household_name;
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Edit Household';

        // Check if existing name matches the auto-generated pattern
        const autoName = formatHouseholdName(household.members);
        if (household.household_name === autoName) {
            isHouseholdNameManuallyEdited = false;
        } else {
            isHouseholdNameManuallyEdited = true;
        }

        // 2. Set Address
        if (household.address) {
            document.getElementById('h-street').value = household.address.street || '';
            document.getElementById('h-street2').value = household.address.street2 || '';
            document.getElementById('h-city').value = household.address.city || '';
            document.getElementById('h-state').value = household.address.state || '';
            document.getElementById('h-zip').value = household.address.zip || '';
        }

        // 3. Set Members
        const container = document.getElementById('members-container');
        container.innerHTML = '';
        memberCount = 0;

        household.members.forEach((m, index) => {
            memberCount++;
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
            memberDiv.id = `member-${memberCount}`;

            // For first member, don't show remove button? Or allowed if multiple?
            // Let's allow removing any member in edit mode, but validation requires at least 1.
            const removeBtn = `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">Remove</button>`;

            memberDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Member ${memberCount}</h6>
                    ${removeBtn}
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-first" value="${m.first_name}" required>
                         <input type="hidden" id="m${memberCount}-id" value="${m.member_id}">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-last" value="${m.last_name}" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m${memberCount}-email" value="${m.email || ''}">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m${memberCount}-phone" value="${m.phone || ''}">
                    </div>
                </div>
            `;
            container.appendChild(memberDiv);

            // Attach listeners
            attachNameListeners(memberCount);
            setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
            setupEmailValidation(document.getElementById(`m${memberCount}-email`));
        });

        // Open Modal
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function deleteHousehold(id) {
        if (!confirm('Are you sure you want to delete this household? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.households = STATE.households.filter(h => h.household_id !== id);
                renderHouseholdsDirectory();
                initAutocomplete(); // Refresh search index
                renderFilters(); // Added to refresh household filters
                showAlert('success', 'Household deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error deleting household: ' + err.message);
            })
            .deleteHousehold(id);
    }

    // --- PROJECT MANAGEMENT ---

    function renderProjectsDirectory() {
        const grid = document.getElementById('projects-grid');
        grid.innerHTML = '';

        // Sort by name
        const sorted = [...STATE.projects].sort((a, b) =>
            (a.name || '').localeCompare(b.name || '')
        );

        sorted.forEach(p => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            col.innerHTML = `
                <div class="card h-100 shadow-sm border-0 border-start border-4 border-primary">
                    <div class="card-body">
                         <div class="d-flex justify-content-between align-items-start mb-2">
                             <h5 class="card-title fw-bold text-primary mb-0">${p.name}</h5>
                             <div class="dropdown">
                                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="editProject('${p.project_id}')"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteProject('${p.project_id}')"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                         </div>
                         <p class="card-text text-muted">${p.description || '<span class="fst-italic">No description</span>'}</p>
                    </div>
                </div>
             `;
            grid.appendChild(col);
        });
    }

    function openAddProjectModal() {
        document.getElementById('add-project-form').reset();
        document.getElementById('project-id').value = '';
        document.querySelector('#addProjectModal .modal-title').textContent = 'Add New Project';
        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    function editProject(id) {
        const project = STATE.projects.find(p => p.project_id === id);
        if (!project) return;

        document.getElementById('project-id').value = project.project_id;
        document.getElementById('p-name').value = project.name;
        document.getElementById('p-desc').value = project.description || '';
        document.querySelector('#addProjectModal .modal-title').textContent = 'Edit Project';

        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    function submitProject() {
        const btn = document.getElementById('btn-save-project');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const project_id = document.getElementById('project-id').value;
        const name = document.getElementById('p-name').value;
        const description = document.getElementById('p-desc').value;

        if (!name) {
            alert("Project Name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { project_id, name, description };

        const handler = (res) => {
            // Handle Success
            if (project_id) {
                // Update Existing
                const idx = STATE.projects.findIndex(p => p.project_id === project_id);
                if (idx !== -1) STATE.projects[idx] = { project_id, name, description };
            } else {
                // Add New
                STATE.projects.push({ project_id: res.project_id, name: res.name, description });
            }

            // Refresh UI and Dropdown
            renderProjectsDirectory();
            refreshProjectDropdown();
            renderFilters(); // Added to refresh dashboard project filter // We need to create this helper or inline it

            // Close Modal
            const modalEl = document.getElementById('addProjectModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            document.getElementById('add-project-form').reset();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', project_id ? 'Project updated successfully!' : 'Project added successfully!');
        };

        if (project_id) {
            google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }).updateProject(payload);
        } else {
            google.script.run.withSuccessHandler(handler).withFailureHandler(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }).saveProject(payload);
        }
    }

    function deleteProject(id) {
        if (!confirm('Are you sure you want to delete this project?')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.projects = STATE.projects.filter(p => p.project_id !== id);
                renderProjectsDirectory();
                refreshProjectDropdown();
                renderFilters(); // Added to refresh dashboard project filter
                showAlert('success', 'Project deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error: ' + err.message);
            })
            .deleteProject(id);
    }
    function refreshProjectDropdown() {
        const projectSelect = document.getElementById('project');
        projectSelect.innerHTML = '<option value="">No Project</option>';
        STATE.projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.project_id;
            option.textContent = p.name;
            projectSelect.appendChild(option);
        });
    }

    // --- ANALYTICS DASHBOARD ---

    function resetDashboardFilters() {
        document.getElementById('filter-year').value = 'All';
        document.getElementById('filter-project').value = 'All';
        document.getElementById('filter-method').value = 'All';
        document.getElementById('filter-amount').value = 0;
        document.getElementById('slider-val-display').textContent = '$0';
        renderDashboard();
    }

    function renderDashboard() {
        // 1. Get Filter Values
        const fYear = document.getElementById('filter-year').value;
        const fProject = document.getElementById('filter-project').value;
        const fMethod = document.getElementById('filter-method').value;
        const fAmount = parseInt(document.getElementById('filter-amount').value);

        // 2. Filter Data
        const filtered = STATE.donations.filter(d => {
            const dYear = new Date(d.date).getFullYear().toString();
            if (fYear !== 'All' && dYear !== fYear) return false;
            if (fProject !== 'All' && d.project_id !== fProject) return false;
            if (fMethod !== 'All' && d.method !== fMethod) return false;
            if (d.amount_cents / 100 < fAmount) return false;
            return true;
        });

        // 3. Compute KPIs
        const totalCents = filtered.reduce((sum, d) => sum + d.amount_cents, 0);
        const totalRaised = totalCents / 100;
        const count = filtered.length;
        const avg = count ? (totalRaised / count) : 0;
        const uniqueDonors = new Set(filtered.map(d => d.household_id)).size;

        // 4. Update KPI Counters with Animation
        animateValue("kpi-total", totalRaised, "$");
        animateValue("kpi-count", count, "");
        animateValue("kpi-avg", avg, "$");
        animateValue("kpi-donors", uniqueDonors, "");

        // 5. Render Charts
        renderCharts(filtered);
    }

    function animateValue(id, value, prefix = "") {
        const obj = document.getElementById(id);
        const start = 0;
        const end = value;
        const duration = 800;
        let startTimestamp = null;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);

            // Format number
            const current = progress * (end - start) + start;
            let formatted;
            if (prefix === "$") {
                formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(current);
            } else {
                formatted = Math.floor(current);
            }

            obj.innerHTML = formatted;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function renderCharts(data) {
        // Chart 1: Timeline (Line)
        // Group by Month (YYYY-MM)
        const timelineData = {};
        data.forEach(d => {
            const key = d.date.substring(0, 7); // YYYY-MM
            timelineData[key] = (timelineData[key] || 0) + (d.amount_cents / 100);
        });
        const timelineLabels = Object.keys(timelineData).sort();
        const timelineValues = timelineLabels.map(k => timelineData[k]);

        createChart('chart-timeline', 'line', timelineLabels, timelineValues, 'Total Raised ($)', '#0d6efd');

        // Chart 2: By Project (Doughnut)
        const projectData = {};
        data.forEach(d => {
            const pName = STATE.projects.find(p => p.project_id === d.project_id)?.name || 'No Project';
            projectData[pName] = (projectData[pName] || 0) + (d.amount_cents / 100);
        });
        createChart('chart-project', 'doughnut', Object.keys(projectData), Object.values(projectData), 'Raised by Project');

        // Chart 3: By Method (Bar)
        const methodData = {};
        data.forEach(d => {
            methodData[d.method] = (methodData[d.method] || 0) + (d.amount_cents / 100);
        });
        createChart('chart-method', 'bar', Object.keys(methodData), Object.values(methodData), 'Raised by Method', '#198754');
    }

    function createChart(canvasId, type, labels, data, label, color) {
        // Destroy existing
        if (CHARTS[canvasId]) {
            CHARTS[canvasId].destroy();
        }

        const ctx = document.getElementById(canvasId).getContext('2d');
        const config = {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: [
                        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
                        '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
                    ],
                    borderColor: type === 'line' ? color : '#fff',
                    borderWidth: 1,
                    tension: 0.3,
                    fill: type === 'line'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: type !== 'doughnut' ? {
                    y: { beginAtZero: true }
                } : {}
            }
        };

        CHARTS[canvasId] = new Chart(ctx, config);
    }

    function submitHousehold() {
        const btn = document.getElementById('btn-save-household');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        // Collect household info
        const household_id = document.getElementById('household-id').value;
        const household_name = document.getElementById('h-name').value;
        const address = {
            street: document.getElementById('h-street').value,
            street2: document.getElementById('h-street2').value,
            city: document.getElementById('h-city').value,
            state: document.getElementById('h-state').value,
            zip: document.getElementById('h-zip').value
        };

        // Collect all members
        const members = [];
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            if (!firstInput) continue; // Skipped if removed

            const first_name = firstInput.value;
            const last_name = document.getElementById(`m${i}-last`).value;
            const email = document.getElementById(`m${i}-email`).value;
            const phone = document.getElementById(`m${i}-phone`).value;
            const member_id = document.getElementById(`m${i}-id`).value; // Get ID if editing

            if (!first_name || !last_name) {
                alert(`Member ${i}: First and Last Name are required.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Email validation (check if visual validation failed)
            const emailInput = document.getElementById(`m${i}-email`);
            if (emailInput.classList.contains('is-invalid')) {
                alert(`Member ${i}: Please fix the invalid email address.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Double check in case they submitted without blurring
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                alert(`Member ${i}: Please enter a valid email address.`);
                emailInput.classList.add('is-invalid');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            members.push({ member_id, first_name, last_name, email, phone });
        }

        if (members.length === 0) {
            alert("At least one household member is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        if (!household_name) {
            alert("Household name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { household_id, household_name, address, members };

        const handler = (res) => {
            // Handle Success (Create or Update)
            const existingIdx = STATE.households.findIndex(h => h.household_id === res.household_id);
            const newHousehold = {
                household_id: res.household_id,
                household_name: payload.household_name,
                address: address,
                members: members
                // Note: Newly created members won't have IDs here until refresh, 
                // but that's okay for UI display. Full refresh on page load fixes it.
                // Ideally we'd return full object from server.
            };

            if (existingIdx !== -1) {
                STATE.households[existingIdx] = newHousehold;
            } else {
                STATE.households.push(newHousehold);
            }

            // Refresh UI
            renderHouseholdsDirectory();
            initAutocomplete(); // Update search index
            renderFilters(); // Added to refresh household filters

            // Close Modal
            const modalEl = document.getElementById('addHouseholdModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Reset Form
            resetAddHouseholdModal();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', household_id ? 'Household updated successfully!' : 'Household added successfully!');
        };

        if (household_id) {
            // Update
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .updateHousehold(payload);
        } else {
            // Create
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .saveHousehold(payload);
        }
    }


    // --- DONATION FORM ---
    function initAutocomplete() {
        const input = document.getElementById('household-search');
        const resultsList = document.getElementById('results-list');
        const hiddenId = document.getElementById('selected-household-id');
        const membersDisplay = document.getElementById('selected-household-members');

        input.addEventListener('keyup', (e) => {
            const query = e.target.value.toLowerCase();
            resultsList.innerHTML = '';
            resultsList.classList.add('d-none');
            membersDisplay.innerHTML = '';

            if (query.length < 2) return;

            const matches = STATE.households.filter(h =>
                (h.search_index || '').toLowerCase().includes(query)
            ).slice(0, 5);

            if (matches.length > 0) {
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action cursor-pointer';
                    li.innerHTML = `
                        <strong>${match.household_name}</strong><br>
                        <small class="text-muted">${formatHouseholdName(match.members)}</small>
                    `;

                    li.onclick = () => {
                        input.value = match.household_name;
                        hiddenId.value = match.household_id;
                        resultsList.classList.add('d-none');
                        input.classList.add('is-valid');

                        // Display member info
                        const memberInfo = match.members.map(m =>
                            `${m.first_name} ${m.last_name}${m.email ? ` (${m.email})` : ''}`
                        ).join('<br>');
                        membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
                    };

                    resultsList.appendChild(li);
                });
                resultsList.classList.remove('d-none');
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== input && e.target !== resultsList) {
                resultsList.classList.add('d-none');
            }
        });
    }

    function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    }

    function showError(err) {
        console.error(err);
        showAlert('danger', 'System Error: ' + err.message);
    }
    // --- DONATION MANAGEMENT ---

    function resetDonationFilters() {
        document.getElementById('dm-filter-year').value = 'All';
        document.getElementById('dm-filter-household').value = 'All';
        document.getElementById('dm-filter-method').value = 'All';
        renderDonationsTable();
    }

    function renderDonationsTable() {
        // 1. Get Filters
        const fYear = document.getElementById('dm-filter-year').value;
        const fHousehold = document.getElementById('dm-filter-household').value;
        const fMethod = document.getElementById('dm-filter-method').value;

        // 2. Filter Data
        const filtered = STATE.donations.filter(d => {
            const dYear = new Date(d.date).getFullYear().toString();
            if (fYear !== 'All' && dYear !== fYear) return false;
            if (fHousehold !== 'All' && d.household_id !== fHousehold) return false;
            if (fMethod !== 'All' && d.method !== fMethod) return false;
            return true;
        });

        // 3. Sort by Date Descending
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

        // 4. Render Rows
        const tbody = document.getElementById('donations-table-body');
        tbody.innerHTML = '';

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">No donations found matching criteria.</td></tr>';
            return;
        }

        filtered.forEach(d => {
            const tr = document.createElement('tr');

            // Format Date (MM/DD/YYYY)
            // Fix parsing to avoid UTC shift issues with simpler date strings if needed
            // But Code.gs returns ISO string usually.
            const dateObj = new Date(d.date);
            // Use UTC methods to ensure date stays same as entered if entered as YYYY-MM-DD
            // However, date input returns YYYY-MM-DD. 
            // Let's stick to standard toLocaleDateString for now.
            const dateStr = dateObj.toLocaleDateString();

            // Format Amount
            const amountStr = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(d.amount_cents / 100);

            // Lookup Names
            const household = STATE.households.find(h => h.household_id === d.household_id);
            const householdName = household ? household.household_name : 'Unknown Household';

            const project = STATE.projects.find(p => p.project_id === d.project_id);
            const projectName = project ? project.name : 'No Project';

            tr.innerHTML = `
                <td>${dateStr}</td>
                <td class="fw-bold">${householdName}</td>
                <td>${amountStr}</td>
                <td>${projectName}</td>
                <td>${d.method}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openDonationModal('${d.txn_id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDonation('${d.txn_id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderHouseholdMembersPreview(members) {
        if (!members || members.length === 0) return;
        const membersDisplay = document.getElementById('selected-household-members');
        const memberInfo = members.map(m =>
            `${m.first_name} ${m.last_name}${m.email ? ` (${m.email})` : ''}`
        ).join('<br>');
        membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
    }

    let donationModal = null; // Store Bootstrap Modal instance

    function openDonationModal(txn_id = null) {
        if (!donationModal) {
            donationModal = new bootstrap.Modal(document.getElementById('donationModal'));
        }

        const form = document.getElementById('donation-form');
        // Reset Validations
        document.getElementById('household-search').classList.remove('is-valid');
        document.getElementById('selected-household-members').innerHTML = '';

        if (txn_id) {
            // EDIT MODE
            const donation = STATE.donations.find(d => d.txn_id === txn_id);
            if (!donation) return;

            document.getElementById('donationModalLabel').innerText = 'Edit Donation';
            document.getElementById('donation-txn-id').value = donation.txn_id;

            // Pre-fill fields
            const household = STATE.households.find(h => h.household_id === donation.household_id);
            document.getElementById('household-search').value = household ? household.household_name : '';
            document.getElementById('selected-household-id').value = donation.household_id;
            document.getElementById('amount').value = donation.amount_cents / 100;

            // Format date for input type="date" (YYYY-MM-DD)
            const d = new Date(donation.date);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;

            document.getElementById('project').value = donation.project_id || '';
            document.getElementById('method').value = donation.method;

            // Show members preview
            if (household) {
                renderHouseholdMembersPreview(household.members);
            }

        } else {
            // ADD MODE
            document.getElementById('donationModalLabel').innerText = 'Log New Donation';
            document.getElementById('donation-txn-id').value = ''; // Empty for new
            form.reset();
            document.getElementById('selected-household-id').value = '';
            document.getElementById('date').valueAsDate = new Date();
        }

        donationModal.show();
    }

    function submitDonation() {
        const btn = document.getElementById('submit-donation-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const txnId = document.getElementById('donation-txn-id').value;
        const householdId = document.getElementById('selected-household-id').value;
        const project = document.getElementById('project').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        const method = document.getElementById('method').value;

        if (!householdId) {
            alert('Please select a household from the search list.');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = {
            txn_id: txnId, // Will be empty if new
            household_id: householdId,
            project_id: project,
            amount_cents: Math.round(amount * 100),
            date: date,
            method: method
        };

        const successHandler = (res) => {
            btn.disabled = false;
            btn.textContent = originalText;

            // Close Modal
            if (donationModal) donationModal.hide();

            // Update Local State
            if (txnId) { // Update
                const idx = STATE.donations.findIndex(d => d.txn_id === txnId);
                if (idx !== -1) STATE.donations[idx] = payload;
            } else { // Create
                payload.txn_id = res.txn_id;
                STATE.donations.push(payload);
            }

            // Refresh Views
            renderDonationsTable();
            renderDashboard();
            renderFilters(); // Added to refresh year/household filters
            showAlert('success', txnId ? 'Donation updated!' : 'Donation logged successfully!');
        };

        const failureHandler = (err) => {
            btn.disabled = false;
            btn.textContent = originalText;
            alert('Error: ' + err.message);
        };

        if (txnId) {
            google.script.run
                .withSuccessHandler(successHandler)
                .withFailureHandler(failureHandler)
                .updateDonation(payload);
        } else {
            google.script.run
                .withSuccessHandler(successHandler)
                .withFailureHandler(failureHandler)
                .saveDonation(payload);
        }
    }

    function deleteDonation(txn_id) {
        if (!confirm('Are you sure you want to delete this donation? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                // Update State
                STATE.donations = STATE.donations.filter(d => d.txn_id !== txn_id);
                // Refresh Views
                renderDonationsTable();
                renderDashboard();
                renderFilters(); // Added to refresh filters
                showAlert('success', 'Donation deleted.');
            })
            .withFailureHandler((err) => {
                alert('Error deleting donation: ' + err.message);
            })
            .deleteDonation(txn_id);
    }
</script>