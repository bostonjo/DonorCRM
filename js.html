<script>
    let STATE = { households: [], projects: [] };

    window.onload = function () {
        document.getElementById('date').valueAsDate = new Date();
        google.script.run
            .withSuccessHandler(initApp)
            .withFailureHandler(showError)
            .getInitialData();
    };

    function initApp(data) {
        STATE.households = data.households;
        STATE.projects = data.projects;

        // Populate Projects Dropdown
        const projectSelect = document.getElementById('project');
        STATE.projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.project_id;
            option.textContent = p.name;
            projectSelect.appendChild(option);
        });

        initAutocomplete();
        renderHouseholdsTable();
        // Initialize auto-naming
        setupHouseholdAutoNaming();
    }

    // --- NAVIGATION ---
    function navigate(viewId, linkElement) {
        // Hide all views
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        // Show target
        document.getElementById(viewId).classList.remove('d-none');

        // Update Sidebar Active State
        if (linkElement) {
            document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
            linkElement.classList.add('active');
        }
    }

    // --- HOUSEHOLD NAME FORMATTING ---
    function formatHouseholdName(members) {
        if (!members || members.length === 0) return "Unknown";

        if (members.length === 1) {
            return `${members[0].first_name} ${members[0].last_name}`;
        }

        // Check if all members share the same last name
        const lastNames = members.map(m => m.last_name);
        const allSameLastName = lastNames.every(ln => ln === lastNames[0]);

        if (allSameLastName) {
            // "John and Jane Smith"
            const firstNames = members.map(m => m.first_name).join(' and ');
            return `${firstNames} ${lastNames[0]}`;
        } else {
            // "John Smith & Jane Doe"
            const fullNames = members.map(m => `${m.first_name} ${m.last_name}`);
            return fullNames.join(' & ');
        }
    }

    // --- HOUSEHOLD MANAGEMENT ---
    function renderHouseholdsTable() {
        const tbody = document.getElementById('households-table-body');
        tbody.innerHTML = '';

        // Sort by household name
        const sorted = [...STATE.households].sort((a, b) =>
            (a.household_name || '').localeCompare(b.household_name || '')
        );

        sorted.forEach(h => {
            const displayName = formatHouseholdName(h.members);
            const emails = h.members.map(m => m.email).filter(e => e).join(', ');
            const phones = h.members.map(m => m.phone).filter(p => p).join(', ');
            const address = h.address ?
                `${h.address.street || ''}${h.address.street2 ? ', ' + h.address.street2 : ''}, ${h.address.city || ''}, ${h.address.state || ''} ${h.address.zip || ''}`.replace(/^[,\s]+|[,\s]+$/g, '')
                : '';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <strong>${h.household_name}</strong><br>
                    <small class="text-muted">${displayName}</small>
                </td>
                <td>${emails || '<span class="text-muted">—</span>'}</td>
                <td>${phones || '<span class="text-muted">—</span>'}</td>
                <td>${address || '<span class="text-muted">—</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editHousehold('${h.household_id}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteHousehold('${h.household_id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Dynamic member input management
    let memberCount = 1;

    // --- PHONE FORMATTING ---
    function formatPhoneNumber(value) {
        if (!value) return value;
        const current = value.replace(/[^\d]/g, '');
        const mobileReg = /(^[0-9]{3})([0-9]{3})([0-9]{4}$)/;
        if (current.length >= 10) {
            return current.replace(mobileReg, '($1) $2-$3').slice(0, 14); // Limit length
        }
        return value;
    }

    function setupPhoneFormatter(input) {
        input.addEventListener('input', function (e) {
            const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
            e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        });
    }

    function setupEmailValidation(input) {
        input.addEventListener('blur', function (e) {
            const email = e.target.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email && !emailRegex.test(email)) {
                e.target.classList.add('is-invalid');
            } else {
                e.target.classList.remove('is-invalid');
            }
        });

        // Remove invalid state as soon as user types again
        input.addEventListener('input', function (e) {
            e.target.classList.remove('is-invalid');
        });
    }

    // --- AUTO-GENERATION LOGIC ---
    let isHouseholdNameManuallyEdited = false;

    function setupHouseholdAutoNaming() {
        const nameInput = document.getElementById('h-name');

        // Track manual edits
        nameInput.addEventListener('input', () => {
            if (nameInput.value.trim() !== '') {
                isHouseholdNameManuallyEdited = true;
            }
        });


        // Attach to initial Member 1
        attachNameListeners(1);
        setupPhoneFormatter(document.getElementById('m1-phone'));
        setupEmailValidation(document.getElementById('m1-email'));

    }

    function openAddHouseholdModal() {
        resetAddHouseholdModal();
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function attachNameListeners(id) {
        const first = document.getElementById(`m${id}-first`);
        const last = document.getElementById(`m${id}-last`);

        if (first) first.addEventListener('input', updateHouseholdNameAuto);
        if (last) last.addEventListener('input', updateHouseholdNameAuto);
    }

    function updateHouseholdNameAuto() {
        if (isHouseholdNameManuallyEdited) return;

        const members = [];
        // Scan all potential members up to memberCount
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            const lastInput = document.getElementById(`m${i}-last`);

            // Only include if input elements exist and have at least one name part
            if (firstInput && lastInput) {
                const first = firstInput.value.trim();
                const last = lastInput.value.trim();

                if (first || last) {
                    members.push({ first_name: first, last_name: last });
                }
            }
        }

        const nameInput = document.getElementById('h-name');
        if (members.length > 0) {
            nameInput.value = formatHouseholdName(members);
        } else {
            nameInput.value = '';
        }
    }

    function addMemberInput() {
        memberCount++;
        const container = document.getElementById('members-container');
        const memberDiv = document.createElement('div');
        memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
        memberDiv.id = `member-${memberCount}`;

        memberDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Member ${memberCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">
                    Remove
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-first" placeholder="First Name" required>
                    <input type="hidden" id="m${memberCount}-id">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" id="m${memberCount}-last" placeholder="Last Name" required>
                </div>
                <div class="col-md-6">
                    <input type="email" class="form-control" id="m${memberCount}-email" placeholder="Email (optional)">
                </div>
                <div class="col-md-6">
                    <input type="tel" class="form-control" id="m${memberCount}-phone" placeholder="Phone (optional)">
                </div>
            </div>
        `;

        container.appendChild(memberDiv);

        // Attach listeners to new inputs
        attachNameListeners(memberCount);
        setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
        setupEmailValidation(document.getElementById(`m${memberCount}-email`));
    }

    function removeMemberInput(id) {
        const element = document.getElementById(`member-${id}`);
        if (element) {
            element.remove();
            // Re-calculate name after removal
            updateHouseholdNameAuto();
        }
    }

    function resetAddHouseholdModal() {
        // Reset Form
        document.getElementById('add-household-form').reset();
        document.getElementById('household-id').value = ''; // Clear ID
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Add New Household';
        isHouseholdNameManuallyEdited = false; // Reset auto-naming flag

        // Reset members container to single member
        document.getElementById('members-container').innerHTML = `
            <div class="member-input-group p-3 mb-3 border rounded bg-light" id="member-1">
                <h6 class="mb-2">Member 1</h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-first" placeholder="First Name" required>
                         <input type="hidden" id="m1-id">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m1-last" placeholder="Last Name" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m1-email" placeholder="Email (optional)">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m1-phone" placeholder="Phone (optional)">
                    </div>
                </div>
            </div>
        `;
        memberCount = 1;
        attachNameListeners(1); // Re-attach listeners to new inputs
        setupPhoneFormatter(document.getElementById('m1-phone')); // Re-attach formatting
        setupEmailValidation(document.getElementById('m1-email')); // Re-attach validation
    }

    function editHousehold(id) {
        const household = STATE.households.find(h => h.household_id === id);
        if (!household) return;

        // Reset modal to clean state
        resetAddHouseholdModal();

        // 1. Set Household ID and basic info
        document.getElementById('household-id').value = household.household_id;
        document.getElementById('h-name').value = household.household_name;
        document.querySelector('#addHouseholdModal .modal-title').textContent = 'Edit Household';

        // Manual edit flag true so we don't overwrite name while editing members
        isHouseholdNameManuallyEdited = true;

        // 2. Set Address
        if (household.address) {
            document.getElementById('h-street').value = household.address.street || '';
            document.getElementById('h-street2').value = household.address.street2 || '';
            document.getElementById('h-city').value = household.address.city || '';
            document.getElementById('h-state').value = household.address.state || '';
            document.getElementById('h-zip').value = household.address.zip || '';
        }

        // 3. Set Members
        const container = document.getElementById('members-container');
        container.innerHTML = '';
        memberCount = 0;

        household.members.forEach((m, index) => {
            memberCount++;
            const memberDiv = document.createElement('div');
            memberDiv.className = 'member-input-group p-3 mb-3 border rounded bg-light';
            memberDiv.id = `member-${memberCount}`;

            // For first member, don't show remove button? Or allowed if multiple?
            // Let's allow removing any member in edit mode, but validation requires at least 1.
            const removeBtn = `<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMemberInput(${memberCount})">Remove</button>`;

            memberDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Member ${memberCount}</h6>
                    ${removeBtn}
                </div>
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-first" value="${m.first_name}" required>
                         <input type="hidden" id="m${memberCount}-id" value="${m.member_id}">
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="m${memberCount}-last" value="${m.last_name}" required>
                    </div>
                    <div class="col-md-6">
                        <input type="email" class="form-control" id="m${memberCount}-email" value="${m.email || ''}">
                    </div>
                    <div class="col-md-6">
                        <input type="tel" class="form-control" id="m${memberCount}-phone" value="${m.phone || ''}">
                    </div>
                </div>
            `;
            container.appendChild(memberDiv);

            // Attach listeners
            attachNameListeners(memberCount);
            setupPhoneFormatter(document.getElementById(`m${memberCount}-phone`));
            setupEmailValidation(document.getElementById(`m${memberCount}-email`));
        });

        // Open Modal
        const modal = new bootstrap.Modal(document.getElementById('addHouseholdModal'));
        modal.show();
    }

    function deleteHousehold(id) {
        if (!confirm('Are you sure you want to delete this household? This action cannot be undone.')) return;

        google.script.run
            .withSuccessHandler(() => {
                STATE.households = STATE.households.filter(h => h.household_id !== id);
                renderHouseholdsTable();
                initAutocomplete(); // Refresh search index
                showAlert('success', 'Household deleted successfully.');
            })
            .withFailureHandler(err => {
                alert('Error deleting household: ' + err.message);
            })
            .deleteHousehold(id);
    }

    function submitHousehold() {
        const btn = document.getElementById('btn-save-household');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        // Collect household info
        const household_id = document.getElementById('household-id').value;
        const household_name = document.getElementById('h-name').value;
        const address = {
            street: document.getElementById('h-street').value,
            street2: document.getElementById('h-street2').value,
            city: document.getElementById('h-city').value,
            state: document.getElementById('h-state').value,
            zip: document.getElementById('h-zip').value
        };

        // Collect all members
        const members = [];
        for (let i = 1; i <= memberCount; i++) {
            const firstInput = document.getElementById(`m${i}-first`);
            if (!firstInput) continue; // Skipped if removed

            const first_name = firstInput.value;
            const last_name = document.getElementById(`m${i}-last`).value;
            const email = document.getElementById(`m${i}-email`).value;
            const phone = document.getElementById(`m${i}-phone`).value;
            const member_id = document.getElementById(`m${i}-id`).value; // Get ID if editing

            if (!first_name || !last_name) {
                alert(`Member ${i}: First and Last Name are required.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Email validation (check if visual validation failed)
            const emailInput = document.getElementById(`m${i}-email`);
            if (emailInput.classList.contains('is-invalid')) {
                alert(`Member ${i}: Please fix the invalid email address.`);
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            // Double check in case they submitted without blurring
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                alert(`Member ${i}: Please enter a valid email address.`);
                emailInput.classList.add('is-invalid');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            members.push({ member_id, first_name, last_name, email, phone });
        }

        if (members.length === 0) {
            alert("At least one household member is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        if (!household_name) {
            alert("Household name is required.");
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = { household_id, household_name, address, members };

        const handler = (res) => {
            // Handle Success (Create or Update)
            const existingIdx = STATE.households.findIndex(h => h.household_id === res.household_id);
            const newHousehold = {
                household_id: res.household_id,
                household_name: payload.household_name,
                address: address,
                members: members
                // Note: Newly created members won't have IDs here until refresh, 
                // but that's okay for UI display. Full refresh on page load fixes it.
                // Ideally we'd return full object from server.
            };

            if (existingIdx !== -1) {
                STATE.households[existingIdx] = newHousehold;
            } else {
                STATE.households.push(newHousehold);
            }

            // Refresh UI
            renderHouseholdsTable();
            initAutocomplete(); // Update search index

            // Close Modal
            const modalEl = document.getElementById('addHouseholdModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Reset Form
            resetAddHouseholdModal();

            btn.disabled = false;
            btn.textContent = originalText;
            showAlert('success', household_id ? 'Household updated successfully!' : 'Household added successfully!');
        };

        if (household_id) {
            // Update
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .updateHousehold(payload);
        } else {
            // Create
            google.script.run
                .withSuccessHandler(handler)
                .withFailureHandler((err) => {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    alert('Error: ' + err.message);
                })
                .saveHousehold(payload);
        }
    }


    // --- DONATION FORM ---
    function initAutocomplete() {
        const input = document.getElementById('household-search');
        const resultsList = document.getElementById('results-list');
        const hiddenId = document.getElementById('selected-household-id');
        const membersDisplay = document.getElementById('selected-household-members');

        input.addEventListener('keyup', (e) => {
            const query = e.target.value.toLowerCase();
            resultsList.innerHTML = '';
            resultsList.classList.add('d-none');
            membersDisplay.innerHTML = '';

            if (query.length < 2) return;

            const matches = STATE.households.filter(h =>
                (h.search_index || '').toLowerCase().includes(query)
            ).slice(0, 5);

            if (matches.length > 0) {
                matches.forEach(match => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item list-group-item-action cursor-pointer';
                    li.innerHTML = `
                        <strong>${match.household_name}</strong><br>
                        <small class="text-muted">${formatHouseholdName(match.members)}</small>
                    `;

                    li.onclick = () => {
                        input.value = match.household_name;
                        hiddenId.value = match.household_id;
                        resultsList.classList.add('d-none');
                        input.classList.add('is-valid');

                        // Display member info
                        const memberInfo = match.members.map(m =>
                            `${m.first_name} ${m.last_name}${m.email ? ` (${m.email})` : ''}`
                        ).join('<br>');
                        membersDisplay.innerHTML = `<small class="text-muted">${memberInfo}</small>`;
                    };

                    resultsList.appendChild(li);
                });
                resultsList.classList.remove('d-none');
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== input && e.target !== resultsList) {
                resultsList.classList.add('d-none');
            }
        });
    }

    function submitForm() {
        const btn = document.getElementById('submit-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        const householdId = document.getElementById('selected-household-id').value;
        const project = document.getElementById('project').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const date = document.getElementById('date').value;
        const method = document.getElementById('method').value;

        if (!householdId) {
            alert('Please select a household from the search list.');
            btn.disabled = false;
            btn.textContent = originalText;
            return;
        }

        const payload = {
            household_id: householdId,
            project_id: project,
            amount_cents: Math.round(amount * 100),
            date: date,
            method: method
        };

        google.script.run
            .withSuccessHandler((res) => {
                btn.disabled = false;
                btn.textContent = originalText;
                showAlert('success', 'Donation saved successfully! ID: ' + res.txn_id);
                document.getElementById('donation-form').reset();
                document.getElementById('selected-household-id').value = '';
                document.getElementById('household-search').classList.remove('is-valid');
                document.getElementById('selected-household-members').innerHTML = '';
                document.getElementById('date').valueAsDate = new Date();
            })
            .withFailureHandler((err) => {
                btn.disabled = false;
                btn.textContent = originalText;
                showAlert('danger', 'Error: ' + err.message);
            })
            .saveDonation(payload);
    }

    function showAlert(type, message) {
        const container = document.getElementById('alert-container');
        container.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    }

    function showError(err) {
        console.error(err);
        showAlert('danger', 'System Error: ' + err.message);
    }
</script>