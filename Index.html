<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <?!= include('css'); ?>
</head>

<body>

  <div class="d-flex" id="wrapper">

    <!-- Sidebar -->
    <div class="bg-dark text-white p-3" id="sidebar-wrapper" style="min-width: 250px; min-height: 100vh;">
      <div class="list-group list-group-flush">
        <button id="nav-dashboard" type="button"
          class="list-group-item list-group-item-action bg-transparent text-white p-3 active"
          onclick="switchView('view-dashboard', this)">
          <i class="bi bi-speedometer2 me-2"></i> Dashboard
        </button>
        <button id="nav-donations" type="button"
          class="list-group-item list-group-item-action bg-transparent text-white-50 p-3"
          onclick="switchView('view-donations', this)">
          <i class="bi bi-wallet2 me-2"></i> Donations
        </button>
        <button id="nav-households" type="button"
          class="list-group-item list-group-item-action bg-transparent text-white-50 p-3"
          onclick="switchView('view-households', this)">
          <i class="bi bi-people me-2"></i> Households
        </button>
        <button id="nav-projects" type="button"
          class="list-group-item list-group-item-action bg-transparent text-white-50 p-3"
          onclick="switchView('view-projects', this)">
          <i class="bi bi-folder me-2"></i> Projects
        </button>
      </div>
    </div>

    <!-- Page Content -->
    <div id="page-content-wrapper" class="container-fluid p-4 bg-light w-100">

      <div id="alert-container"></div>

      <!-- VIEW: DASHBOARD (New Home) -->
      <div id="view-dashboard" class="view-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Analytics Dashboard</h2>
          <div class="d-flex gap-2 align-items-center">
            <select class="form-select form-select-sm" id="filter-year-start" onchange="renderDashboard()">
              <!-- JS populated -->
            </select>
            <span class="text-muted">-</span>
            <select class="form-select form-select-sm" id="filter-year-end" onchange="renderDashboard()">
              <!-- JS populated -->
            </select>
          </div>
        </div>

        <!-- Filters Row -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-3">
            <div class="row g-3 align-items-end">
              <div class="col-md-3">
                <label class="form-label small fw-bold">Project</label>
                <select class="form-select form-select-sm" id="filter-project" onchange="renderDashboard()">
                  <option value="All">All Projects</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-bold">Method</label>
                <select class="form-select form-select-sm" id="filter-method" onchange="renderDashboard()">
                  <option value="All">All Methods</option>
                  <option value="Check">Check</option>
                  <option value="Venmo">Venmo</option>
                  <option value="PayPal">PayPal</option>
                  <option value="Cash">Cash</option>
                  <option value="DAF/Family Gift/QCD">DAF/Family Gift/QCD</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-bold d-flex justify-content-between">
                  <span>Min. Amount</span>
                  <span id="slider-val-display" class="text-primary">$0</span>
                </label>
                <input type="range" class="form-range" id="filter-amount" min="0" max="1000" step="10" value="0"
                  oninput="document.getElementById('slider-val-display').textContent = '$' + this.value; renderDashboard()">
              </div>
              <div class="col-md-2 text-end">
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetDashboardFilters()">Reset</button>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card shadow-sm border-start border-primary border-3 h-100" style="cursor: pointer;"
              onclick="goToDonationsFiltered()">
              <div class="card-body">
                <h6 class="text-muted text-uppercase small">Total Raised</h6>
                <h3 class="mb-0 fw-bold" id="kpi-total">$0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm border-start border-success border-3 h-100" style="cursor: pointer;"
              onclick="goToDonationsFiltered()">
              <div class="card-body">
                <h6 class="text-muted text-uppercase small">Donations</h6>
                <h3 class="mb-0 fw-bold" id="kpi-count">0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm border-start border-info border-3 h-100">
              <div class="card-body">
                <h6 class="text-muted text-uppercase small">Avg. Donation</h6>
                <h3 class="mb-0 fw-bold" id="kpi-avg">$0</h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm border-start border-warning border-3 h-100" style="cursor: pointer;"
              onclick="goToDonationsFiltered()">
              <div class="card-body">
                <h6 class="text-muted text-uppercase small">Unique Donors</h6>
                <h3 class="mb-0 fw-bold" id="kpi-donors">0</h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-4 mb-4">
          <div class="col-lg-8">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-white fw-bold">Donations Over Time</div>
              <div class="card-body">
                <canvas id="chart-timeline" style="max-height: 300px;"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-white fw-bold">By Project</div>
              <div class="card-body">
                <canvas id="chart-project" style="max-height: 250px;"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="row g-4">
          <div class="col-lg-6">
            <div class="card shadow-sm">
              <div class="card-header bg-white fw-bold">Top Payment Methods</div>
              <div class="card-body">
                <canvas id="chart-method" style="max-height: 250px;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VIEW: DONATION MANAGEMENT (List + Filters) -->
      <div id="view-donations" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0">Donation Management</h2>
          <button class="btn btn-primary" onclick="openDonationModal()">
            <i class="bi bi-plus-lg"></i> Log New Donation
          </button>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-4">
          <div class="card-body p-3">
            <div class="row g-3 align-items-end">
              <div class="col-md-4"> <!-- Expanded width for date range -->
                <label class="form-label small fw-bold">Year Range</label>
                <div class="d-flex gap-2 align-items-center">
                  <select class="form-select form-select-sm" id="dm-filter-year-start"
                    onchange="renderDonationsTable()">
                    <!-- JS -->
                  </select>
                  <span class="text-muted">-</span>
                  <select class="form-select form-select-sm" id="dm-filter-year-end" onchange="renderDonationsTable()">
                    <!-- JS -->
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-bold">Household</label>
                <select class="form-select form-select-sm" id="dm-filter-household" onchange="renderDonationsTable()">
                  <option value="All">All Households</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label small fw-bold">Method</label>
                <select class="form-select form-select-sm" id="dm-filter-method" onchange="renderDonationsTable()">
                  <option value="All">All Methods</option>
                  <option value="Check">Check</option>
                  <option value="Venmo">Venmo</option>
                  <option value="PayPal">PayPal</option>
                  <option value="Cash">Cash</option>
                  <option value="DAF/Family Gift/QCD">DAF/Family Gift/QCD</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-3 text-end">
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetDonationFilters()">Reset
                  Filters</button>
              </div>

              <!-- Donations Summary Container -->
              <div id="donations-summary" class="mb-4">
                <!-- Populated by JS -->
              </div>

              <!-- Table -->
              <div class="card shadow-sm">
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Household</th>
                          <th>Amount</th>
                          <th>Project</th>
                          <th>Method</th>
                          <th class="text-end">Actions</th>
                        </tr>
                      </thead>
                      <tbody id="donations-table-body">
                        <!-- JS Populated -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- /#view-donations -->

      <!-- MODAL: Add/Edit Donation -->
      <div class="modal fade" id="donationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="donationModalLabel">Log New Donation</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="donation-form" onsubmit="event.preventDefault(); submitDonation();">
                <input type="hidden" id="donation-txn-id"> <!-- Hidden ID for updates -->

                <div class="mb-3 position-relative">
                  <label class="form-label">Household Search</label>
                  <input type="text" class="form-control" id="household-search"
                    placeholder="Type to search households..." autocomplete="off">
                  <input type="hidden" id="selected-household-id" name="household_id">
                  <ul id="results-list" class="list-group position-absolute w-100 d-none" style="z-index: 1050;">
                  </ul>
                  <div id="selected-household-members" class="mt-2"></div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Amount ($)</label>
                  <input type="number" class="form-control" id="amount" step="0.01" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" id="date" required>
                </div>

                <div class="mb-3">
                  <label class="form-label">Project</label>
                  <select class="form-select" id="project"></select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Method</label>
                  <select class="form-select" id="method" required>
                    <option value="" disabled selected>Select...</option>
                    <option value="Check">Check</option>
                    <option value="Venmo">Venmo</option>
                    <option value="PayPal">PayPal</option>
                    <option value="Cash">Cash</option>
                    <option value="DAF/Family Gift/QCD">DAF/Family Gift/QCD</option>
                    <option value="Other">Other</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Comments (Optional)</label>
                  <textarea class="form-control" id="comments" rows="2"></textarea>
                </div>

                <button type="submit" id="submit-donation-btn" class="btn btn-primary w-100">Save
                  Donation</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- VIEW: HOUSEHOLDS -->
      <div id="view-households" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Household Directory</h2>
          <button class="btn btn-success" onclick="openAddHouseholdModal()">
            <i class="bi bi-house-add"></i> Add New Household
          </button>
        </div>

        <div id="households-grid" class="row g-3">
          <!-- JS Rendered Cards -->
        </div>
      </div>

      <!-- VIEW: PROJECTS -->
      <div id="view-projects" class="view-section d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2>Project Management</h2>
          <button class="btn btn-primary" onclick="openAddProjectModal()">
            <i class="bi bi-plus-circle"></i> Add Project
          </button>
        </div>

        <div id="projects-grid" class="row g-3">
          <!-- JS Rendered Cards -->
        </div>
      </div>
      <!-- /#view-projects -->

    </div>
    <!-- /#page-content-wrapper -->
  </div>
  <!-- /#wrapper -->

  <!-- MODAL: ADD HOUSEHOLD -->
  <div class="modal fade" id="addHouseholdModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Household</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-household-form">
            <input type="hidden" id="household-id"> <!-- Hidden Household ID -->

            <!-- Members -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                <h6 class="mb-0">Household Members</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addMemberInput()">
                  <i class="bi bi-person-plus"></i> Add Member
                </button>
              </div>

              <div id="members-container">
                <!-- Member 1 (default) -->
                <div class="member-input-group p-3 mb-3 border rounded bg-light" id="member-1">
                  <input type="hidden" id="m1-id"> <!-- Hidden ID -->
                  <h6 class="mb-2">Member 1</h6>
                  <div class="row g-2">
                    <div class="col-md-6">
                      <input type="text" class="form-control" id="m1-first" placeholder="First Name" required>
                    </div>
                    <div class="col-md-6">
                      <input type="text" class="form-control" id="m1-last" placeholder="Last Name" required>
                    </div>
                    <div class="col-md-6">
                      <input type="email" class="form-control" id="m1-email" placeholder="Email (optional)">
                    </div>
                    <div class="col-md-6">
                      <input type="tel" class="form-control" id="m1-phone" placeholder="Phone (optional)">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Household Info -->
            <div class="mb-3">
              <h6 class="border-bottom pb-2">Household Information</h6>
              <div class="mb-3">
                <label class="form-label">Household Name</label>
                <input type="text" class="form-control" id="h-name" placeholder="e.g., The Smith Family" required>
                <div class="form-text">Auto-generated from member names unless manually edited.</div>
              </div>

              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label">Street Address</label>
                  <input type="text" class="form-control" id="h-street" placeholder="123 Main St">
                </div>
                <div class="col-12">
                  <label class="form-label">Address Line 2 <span class="text-muted fw-light">(Optional)</span></label>
                  <input type="text" class="form-control" id="h-street2" placeholder="Apt, Unit, Suite, etc.">
                </div>
                <div class="col-md-5">
                  <label class="form-label">City</label>
                  <input type="text" class="form-control" id="h-city" placeholder="Boston">
                </div>
                <div class="col-md-3">
                  <label class="form-label">State</label>
                  <input type="text" class="form-control" id="h-state" placeholder="MA" maxlength="2">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Zip Code</label>
                  <input type="text" class="form-control" id="h-zip" placeholder="02101 or 02101-1234">
                </div>
              </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="submitHousehold()" id="btn-save-household">Save
            Household</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-project-form">
            <input type="hidden" id="project-id">
            <div class="mb-3">
              <label class="form-label">Project Name</label>
              <input type="text" class="form-control" id="p-name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (Optional)</label>
              <textarea class="form-control" id="p-desc" rows="3"></textarea>
            </div>
            <button type="button" class="btn btn-primary w-100" id="btn-save-project" onclick="submitProject()">Save
              Project</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <?!= include('js'); ?>
</body>

</html>